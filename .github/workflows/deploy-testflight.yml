name: ğŸš€ Deploy to TestFlight

on:
  workflow_run:
    workflows: ['ğŸ“ CHANGELOG Update']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-testflight:
    name: ğŸš€ Deploy to TestFlight
    runs-on: macos-14
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ğŸ“‹ Job ì‹œì‘ ë° í•„ìˆ˜ Secrets ê²€ì¦
        run: |
          echo "ğŸš€ ========================================"
          echo "ğŸš€ Deploy to TestFlight Job ì‹œì‘"
          echo "ğŸš€ ========================================"
          echo "ğŸ“… ì‹œì‘ ì‹œê°„: $(date)"
          echo "ğŸ”§ Runner OS: ${{ runner.os }}"
          echo "ğŸ’» Runner Architecture: ${{ runner.arch }}"
          echo ""
          echo "ğŸ” í•„ìˆ˜ GitHub Secrets ê²€ì¦:"

          # í•„ìˆ˜ Secrets ëª©ë¡
          MISSING_SECRETS=""

          if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "âŒ APPLE_CERTIFICATE_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_CERTIFICATE_BASE64"
          else
            echo "âœ… APPLE_CERTIFICATE_BASE64"
          fi

          if [ -z "$APPLE_CERTIFICATE_PASSWORD" ]; then
            echo "âŒ APPLE_CERTIFICATE_PASSWORD ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_CERTIFICATE_PASSWORD"
          else
            echo "âœ… APPLE_CERTIFICATE_PASSWORD"
          fi

          if [ -z "$APPLE_PROVISIONING_PROFILE_BASE64" ]; then
            echo "âŒ APPLE_PROVISIONING_PROFILE_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_PROVISIONING_PROFILE_BASE64"
          else
            echo "âœ… APPLE_PROVISIONING_PROFILE_BASE64"
          fi

          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "âŒ APP_STORE_CONNECT_API_KEY_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_API_KEY_ID"
          else
            echo "âœ… APP_STORE_CONNECT_API_KEY_ID"
          fi

          if [ -z "$APP_STORE_CONNECT_ISSUER_ID" ]; then
            echo "âŒ APP_STORE_CONNECT_ISSUER_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_ISSUER_ID"
          else
            echo "âœ… APP_STORE_CONNECT_ISSUER_ID"
          fi

          if [ -z "$APP_STORE_CONNECT_API_KEY_BASE64" ]; then
            echo "âŒ APP_STORE_CONNECT_API_KEY_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_API_KEY_BASE64"
          else
            echo "âœ… APP_STORE_CONNECT_API_KEY_BASE64"
          fi

          if [ -z "$APPLE_ID" ]; then
            echo "âŒ APPLE_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_ID"
          else
            echo "âœ… APPLE_ID: $APPLE_ID"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo ""
            echo "âŒ ========================================"
            echo "âŒ ëˆ„ë½ëœ GitHub Secrets:"
            for secret in $MISSING_SECRETS; do
              echo "  - $secret"
            done
            echo "âŒ ========================================"
            echo "í•´ê²° ë°©ë²•: GitHub ì €ì¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ ëˆ„ë½ëœ Secretsë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          echo ""
          echo "âœ… ëª¨ë“  í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸš€ ========================================"
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          APPLE_ID: ${{ secrets.APPLE_ID }}

      - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: âœ… ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“ í”„ë¡œì íŠ¸ íŒŒì¼ í™•ì¸:"
          ls -la | head -10
          echo "ğŸ“¦ package.json ë²„ì „ í™•ì¸:"
          node -p "require('./package.json').version"
          echo "âœ… ========================================"

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: âœ… Node.js ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Node.js ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ“¦ Node.js ë²„ì „: $(node --version)"
          echo "ğŸ“¦ npm ë²„ì „: $(npm --version)"
          echo "âœ… ========================================"

      - name: ğŸ“¦ JavaScript ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ ========================================"
          echo "ğŸ“¦ JavaScript ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ“¦ ========================================"
          npm ci
          echo "âœ… JavaScript ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          echo "ğŸ“Š ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ìˆ˜: $(ls node_modules | wc -l)"
          echo "ğŸ“¦ ========================================"

      - name: ğŸ Xcode ì„¤ì •
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: âœ… Xcode ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Xcode ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ Xcode ë²„ì „: $(xcodebuild -version)"
          echo "ğŸ ì‚¬ìš© ê°€ëŠ¥í•œ SDK:"
          xcodebuild -showsdks | grep iOS
          echo "âœ… ========================================"

      - name: ğŸ’ Ruby ì„¤ì •
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: âœ… Ruby ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Ruby ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ’ Ruby ë²„ì „: $(ruby --version)"
          echo "ğŸ’ Bundler ë²„ì „: $(bundle --version)"
          echo "âœ… ========================================"

      - name: ğŸ’ Fastlane ì„¤ì¹˜ (Bundle Install)
        run: |
          echo "ğŸ’ ========================================"
          echo "ğŸ’ Fastlane ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ’ ========================================"
          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ“‹ Gemfile ë‚´ìš© í™•ì¸:"
          cat Gemfile

          echo ""
          echo "ğŸ“¦ Bundle install ì‹¤í–‰ ì¤‘..."
          bundle install

          echo ""
          echo "âœ… Bundle install ì™„ë£Œ!"
          echo "ğŸ’ ì„¤ì¹˜ëœ Fastlane ë²„ì „: $(bundle exec fastlane --version | head -1)"
          echo "ğŸ’ ========================================"

      - name: ğŸ—ï¸ CocoaPods ì„¤ì¹˜
        run: |
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ—ï¸ CocoaPods ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ—ï¸ ========================================"
          gem install cocoapods -N
          echo "ğŸ“¦ CocoaPods ë²„ì „: $(pod --version)"
          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ Pod ì„¤ì¹˜..."
          cd ios && pod install --repo-update
          echo "âœ… CocoaPods ì„¤ì¹˜ ì™„ë£Œ"
          echo "ğŸ“Š ì„¤ì¹˜ëœ Pod ìˆ˜:"
          ls ios/Pods | grep -v "Headers\|Target" | wc -l
          echo "ğŸ—ï¸ ========================================"

      # ì¸ì¦ì„œ ì„¤ì¹˜ (ì•„ì¹´ì´ë¸Œ ë¹Œë“œì— í•„ìš”)
      - name: ğŸ” ì¸ì¦ì„œ ì„¤ì¹˜ ì‚¬ì „ ê²€ì¦
        run: |
          echo "ğŸ” ========================================"
          echo "ğŸ” Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜ ì‚¬ì „ ê²€ì¦"
          echo "ğŸ” ========================================"
          echo "ğŸ“‹ ì¸ì¦ì„œ ì„¤ì¹˜ ì „ í‚¤ì²´ì¸ ìƒíƒœ:"
          security list-keychains -d user
          echo ""
          echo "ğŸ” GitHub Secrets ê²€ì¦:"
          if [ -z "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" ]; then
            echo "âŒ APPLE_CERTIFICATE_BASE64 Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… APPLE_CERTIFICATE_BASE64 Secret ì¡´ì¬í•¨"
            echo "ğŸ“Š ì¸ì¦ì„œ ë°ì´í„° ê¸¸ì´: ${#APPLE_CERTIFICATE_BASE64}"
          fi

          if [ -z "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" ]; then
            echo "âŒ APPLE_CERTIFICATE_PASSWORD Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… APPLE_CERTIFICATE_PASSWORD Secret ì¡´ì¬í•¨"
          fi
          echo "ğŸ” ========================================"
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}

      - name: ğŸ” Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          keychain: signing_temp
          create-keychain: true

      - name: âœ… ì¸ì¦ì„œ ì„¤ì¹˜ ì™„ë£Œ í™•ì¸
        run: |
          echo "âœ… ========================================"
          echo "âœ… Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜ ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ” ì„¤ì¹˜ëœ í‚¤ì²´ì¸ ëª©ë¡:"
          security list-keychains -d user
          echo ""
          echo "ğŸ” ì„¤ì¹˜ëœ ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ:"
          security find-identity -v -p codesigning
          echo ""
          echo "ğŸ” ê¸°ë³¸ í‚¤ì²´ì¸:"
          security default-keychain
          echo "âœ… ========================================"

      # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
      - name: ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "ğŸ“± ========================================"
          echo "ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ“± ========================================"

          echo "ğŸ“‚ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

          echo "ğŸ” Base64 í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì¤‘..."
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          echo "âœ… í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì™„ë£Œ"
          echo "ğŸ“Š ë””ì½”ë”©ëœ íŒŒì¼ í¬ê¸°: $(du -h profile.mobileprovision | cut -f1)"

          echo "ğŸ“‹ í”„ë¡œíŒŒì¼ ì •ë³´ ì¶”ì¶œ ì¤‘..."
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))

          echo "ğŸ“‹ ì¶”ì¶œëœ í”„ë¡œíŒŒì¼ ì •ë³´:"
          echo "  - UUID: $PROFILE_UUID"
          echo "  - Name: $PROFILE_NAME"

          # CLI í”„ë¡œì íŠ¸ìš© í”„ë¡œíŒŒì¼ì¸ì§€ í™•ì¸
          if [[ "$PROFILE_NAME" == *"expo"* ]]; then
            echo "âŒ ========================================"
            echo "âŒ ì—ëŸ¬: Expo í”„ë¡œíŒŒì¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "âŒ ========================================"
            echo "í˜„ì¬ í”„ë¡œíŒŒì¼: $PROFILE_NAME"
            echo ""
            echo "í•´ê²° ë°©ë²•:"
            echo "1. Apple Developer Consoleì—ì„œ CLI í”„ë¡œì íŠ¸ìš© Distribution í”„ë¡œíŒŒì¼ ìƒì„±"
            echo "2. í•´ë‹¹ í”„ë¡œíŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©"
            echo "3. GitHub Secretsì˜ APPLE_PROVISIONING_PROFILE_BASE64 ì—…ë°ì´íŠ¸"
            echo ""
            echo "CLI í”„ë¡œì íŠ¸ì—ëŠ” Expo í”„ë¡œíŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "âŒ ========================================"
            exit 1
          fi

          echo "ğŸ“‚ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì¤‘..."
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          echo "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" >> $GITHUB_ENV

          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì™„ë£Œ!"
          echo "ğŸ” ì„¤ì¹˜ëœ í”„ë¡œíŒŒì¼ í™•ì¸:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "ğŸ“± ========================================"

      - name: ğŸ“Š ë²„ì „ ì •ë³´ ìˆ˜ì§‘
        id: version
        run: |
          echo "ğŸ“Š ========================================"
          echo "ğŸ“Š ë²„ì „ ì •ë³´ ìˆ˜ì§‘ ì‹œì‘"
          echo "ğŸ“Š ========================================"

          VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER=$(git rev-list --count HEAD)

          echo "ğŸ“¦ ìˆ˜ì§‘ëœ ë²„ì „ ì •ë³´:"
          echo "  - ë²„ì „ëª…: $VERSION"
          echo "  - ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER"
          echo "  - Git ì»¤ë°‹ ìˆ˜: $(git rev-list --count HEAD)"
          echo "  - í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "  - ìµœì‹  ì»¤ë°‹: $(git log -1 --format='%h %s')"

          echo "version_name=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“Š ========================================"

      - name: ğŸ—ï¸ iOS ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
        run: |
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ—ï¸ iOS ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì‹œì‘"
          echo "ğŸ—ï¸ ========================================"

          echo "ğŸ” ë¹Œë“œ ì „ í™˜ê²½ í™•ì¸:"
          echo "  - ì„¤ì¹˜ëœ í‚¤ì²´ì¸:"
          security list-keychains -d user
          echo "  - ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ:"
          security find-identity -v -p codesigning

          echo ""
          echo "ğŸ“‹ ë¹Œë“œ ì„¤ì • ì •ë³´:"
          echo "  - í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼: ${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          echo "  - ì•± ë²„ì „: ${{ steps.version.outputs.version_name }}"
          echo "  - ë¹Œë“œ ë²ˆí˜¸: ${{ steps.version.outputs.build_number }}"
          echo "  - ì•„ì¹´ì´ë¸Œ ê²½ë¡œ: build/Wit.xcarchive"

          echo ""
          echo "ğŸš€ xcodebuild ì•„ì¹´ì´ë¸Œ ëª…ë ¹ ì‹¤í–‰ ì¤‘..."
          echo "ğŸ—ï¸ ========================================"

          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -archivePath build/Wit.xcarchive \
            -allowProvisioningUpdates \
            clean archive \
            CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
            MARKETING_VERSION=${{ steps.version.outputs.version_name }} \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"

          echo "ğŸ—ï¸ ========================================"
          echo "âœ… ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì™„ë£Œ!"
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ“ ìƒì„±ëœ ì•„ì¹´ì´ë¸Œ í™•ì¸:"
          if [ -d "build/Wit.xcarchive" ]; then
            echo "  âœ… ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì¡´ì¬í•¨"
            echo "  ğŸ“Š ì•„ì¹´ì´ë¸Œ í¬ê¸°: $(du -sh build/Wit.xcarchive | cut -f1)"
            echo "  ğŸ“‚ ì•„ì¹´ì´ë¸Œ ë‚´ìš©:"
            ls -la build/Wit.xcarchive/
          else
            echo "  âŒ ì•„ì¹´ì´ë¸Œ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "ğŸ—ï¸ ========================================"

      - name: ğŸ”‘ App Store Connect API Key ì„¤ì •
        run: |
          echo "ğŸ”‘ ========================================"
          echo "ğŸ”‘ App Store Connect API Key ì„¤ì • ì‹œì‘"
          echo "ğŸ”‘ ========================================"

          echo "ğŸ“‚ API Key ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p ~/.appstoreconnect/private_keys

          echo "ğŸ”“ API Key ë””ì½”ë”© ë° ì €ì¥ ì¤‘..."
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$API_KEY_PATH" >> $GITHUB_ENV

          echo "âœ… API Key ì„¤ì • ì™„ë£Œ!"
          echo "ğŸ“ API Key íŒŒì¼ í™•ì¸:"
          echo "  - ê²½ë¡œ: $API_KEY_PATH"
          echo "  - íŒŒì¼ ì¡´ì¬: $([ -f "$API_KEY_PATH" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - íŒŒì¼ í¬ê¸°: $([ -f "$API_KEY_PATH" ] && du -h "$API_KEY_PATH" | cut -f1 || echo "N/A")"
          echo "ğŸ”‘ ========================================"

      - name: Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes-${{ steps.version.outputs.version_name }}
          path: .
          github-token: ${{ secrets.PAT_TOKEN }}

      - name: Read changelog file for TestFlight
        id: read_changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Fastlane TestFlight ì§ì ‘ ì—…ë¡œë“œ
        run: |
          echo "ğŸš€ ========================================"
          echo "ğŸš€ ì•„ì¹´ì´ë¸Œ â†’ TestFlight"
          echo "ğŸš€ ========================================"

          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          # Release notes ì„¤ì •
          CHANGELOG_CONTENT="${{ steps.read_changelog.outputs.changelog }}"
          echo "$CHANGELOG_CONTENT" > ../.changelog.txt
          export CHANGELOG="$(cat ../.changelog.txt)"

          # ğŸ” ëª¨ë“  GitHub Secretsë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ Export
          echo "ğŸ” GitHub Secretsë¥¼ Fastlane í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ì¤‘..."

          # App Store Connect API ê´€ë ¨
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export APP_STORE_CONNECT_API_KEY_PATH="${{ env.APP_STORE_CONNECT_API_KEY_PATH }}"

          # Apple Developer ê³„ì • ê´€ë ¨
          export APPLE_ID="${{ secrets.APPLE_ID }}"
          export APPLE_TEAM_ID="${{ secrets.APPLE_TEAM_ID }}"

          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ (ë™ì ìœ¼ë¡œ ì¶”ì¶œëœ ê°’)
          export PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"

          # ì½”ë“œ ì‚¬ì´ë‹ ê´€ë ¨ (Fastfileì—ì„œ í•„ìš”ì‹œ ì‚¬ìš©)
          export APPLE_CERTIFICATE_PASSWORD="${{ secrets.APPLE_CERTIFICATE_PASSWORD }}"

          echo "âœ… ëª¨ë“  í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"

          echo "ğŸ” ì„¤ì •ëœ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  - CHANGELOG(preview): $(echo "$CHANGELOG" | head -c 80 | tr '\n' ' ')..."
          echo "  - API_KEY_ID: $APP_STORE_CONNECT_API_KEY_ID"
          echo "  - API_KEY_PATH: $APP_STORE_CONNECT_API_KEY_PATH"
          echo "  - APPLE_ID: $APPLE_ID"
          echo "  - APPLE_TEAM_ID: $APPLE_TEAM_ID"
          echo "  - PROVISIONING_PROFILE: $PROVISIONING_PROFILE_SPECIFIER"

          echo ""
          echo "ğŸ“‹ ì—…ë¡œë“œ ì¤€ë¹„ ìƒíƒœ í™•ì¸:"
          echo "  - ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì¡´ì¬: $([ -d "../build/Wit.xcarchive" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - API Key íŒŒì¼ ì¡´ì¬: $([ -f "$APP_STORE_CONNECT_API_KEY_PATH" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"

          if [ ! -d "../build/Wit.xcarchive" ]; then
            echo "âŒ ì•„ì¹´ì´ë¸Œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          if [ ! -f "$APP_STORE_CONNECT_API_KEY_PATH" ]; then
            echo "âŒ App Store Connect API Key íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo ""
          echo "ğŸš€ Fastlane ì§ì ‘ ì—…ë¡œë“œ ì‹¤í–‰ ì¤‘..."
          echo "ğŸš€ ========================================"

          echo "ğŸ” Fastlane ì‹¤í–‰ ì „ ìµœì¢… í™•ì¸:"
          echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "  - Fastfile ì¡´ì¬: $([ -f "fastlane/Fastfile" ] && echo "âœ…" || echo "âŒ")"
          echo "  - Bundle ìƒíƒœ: $(bundle --version)"

          # Fastlane ì‹¤í–‰
          echo "ğŸš€ ì‹¤ì œ Fastlane ëª…ë ¹ ì‹¤í–‰..."
          bundle exec fastlane upload_archive_to_testflight

          echo "ğŸš€ ========================================"
          echo "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
          echo "ğŸš€ ========================================"

      - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ë¡œê·¸
        run: |
          echo "ğŸ‰ ========================================"
          echo "ğŸ‰ TestFlight ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ‰ ========================================"
          echo "ğŸ“± ì•±ì´ TestFlightì— ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“… ë°°í¬ ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ğŸ“¦ ë°°í¬ëœ ë²„ì „: ${{ steps.version.outputs.version_name }}"
          echo "ğŸ”¢ ë¹Œë“œ ë²ˆí˜¸: ${{ steps.version.outputs.build_number }}"
          echo ""
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
          echo "  1. TestFlightì—ì„œ ë¹Œë“œ ì²˜ë¦¬ ì™„ë£Œ ëŒ€ê¸°"
          echo "  2. ë‚´ë¶€ í…ŒìŠ¤í„°ì—ê²Œ ì•Œë¦¼ ë°œì†¡"
          echo "  3. í…ŒìŠ¤íŠ¸ ì§„í–‰ í›„ App Store ì¶œì‹œ ì¤€ë¹„"
          echo "ğŸ‰ ========================================"

      - name: Upload iOS build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts-${{ github.run_id }}
          path: |
            build/Wit.xcarchive
            build/ipa/*.ipa
            build/ExportOptions.plist
            ios/fastlane/report.xml
            /Users/runner/Library/Logs/gym
            /Users/runner/Library/Logs/fastlane
            /Users/runner/Library/Logs/xcodebuild
          if-no-files-found: ignore
          retention-days: 7

      # ì„±ê³µ ì‹œì—ë„ ì£¼ìš” ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
      - name: Upload iOS build artifacts (on success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-success-${{ github.run_id }}
          path: |
            build/ipa/*.ipa
            ios/fastlane/report.xml
          if-no-files-found: ignore
          retention-days: 3

  update-readme:
    name: ğŸ“ Update README
    needs: deploy-testflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get latest version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "latest_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update README.md
        run: |
          VERSION="${{ steps.version.outputs.latest_version }}"
          TIMESTAMP=$(date +'%Y-%m-%d')
          VERSION_TEXT="v${VERSION} (${TIMESTAMP})"

          echo "ğŸ” CHANGELOG.jsonì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ ì¤‘..."

          # jq ì„¤ì¹˜ í™•ì¸
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jq ì„¤ì¹˜ ì¤‘..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # CHANGELOG.jsonì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ (Expo ë°©ì‹)
          if [ -f "CHANGELOG.json" ]; then
            LATEST_RELEASE=$(jq '.releases[0]' CHANGELOG.json)
            
            if [ "$LATEST_RELEASE" != "null" ]; then
              # ì¹´í…Œê³ ë¦¬ë³„ ë³€ê²½ì‚¬í•­ì„ í•œêµ­ì–´ ì œëª©ìœ¼ë¡œ ë³€í™˜
              LATEST_CHANGES=$(echo "$LATEST_RELEASE" | jq -r '
                .changes | to_entries[] | 
                (if .key == "chores" then "**ì‘ì—… ì •ë¦¬**"
                 elif .key == "features" then "**ìƒˆë¡œìš´ ê¸°ëŠ¥**"
                 elif .key == "bug_fixes" then "**ë²„ê·¸ ìˆ˜ì •**"
                 elif .key == "documentation" then "**ë¬¸ì„œí™”**"
                 elif .key == "refactor" then "**ë¦¬íŒ©í† ë§**"
                 elif .key == "style" then "**ìŠ¤íƒ€ì¼ë§**"
                 elif .key == "test" then "**í…ŒìŠ¤íŠ¸**"
                 else "**" + (.key | gsub("_"; " ") | ascii_upcase) + "**"
                 end) + "\n" + 
                (.value | map("- " + .) | join("\n")) + "\n"
              ')
              echo "âœ… CHANGELOG.jsonì—ì„œ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ ì™„ë£Œ"
            else
              LATEST_CHANGES="**ì¼ë°˜**\n- ìƒˆë¡œìš´ ë²„ì „ì´ ì¶œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
              echo "âš ï¸ CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©"
            fi
          else
            LATEST_CHANGES="**ì¼ë°˜**\n- ìƒˆë¡œìš´ ë²„ì „ì´ ì¶œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "âš ï¸ CHANGELOG.json íŒŒì¼ì´ ì—†ì–´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©"
          fi

          # README.md ì—…ë°ì´íŠ¸
          cat > README.md << EOF
          # Wit App

          ì—¬í–‰ ì¹œêµ¬ ì°¾ê¸°

          ---

          ## ìµœì‹  ë²„ì „: ${VERSION_TEXT}

          ### ë³€ê²½ ì‚¬í•­

          ${LATEST_CHANGES}

          ### ì´ì „ ë³€ê²½ ì‚¬í•­

          [ì´ì „ ë³€ê²½ì‚¬í•­ ë³´ê¸°](PREVIOUS_CHANGES.md)

          **DOCUMENTATION**

          - Expo -> Clië¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

          ---

          <!-- [ì´ì „ ë³€ê²½ì‚¬í•­ ë³´ê¸°](PREVIOUS_CHANGES.md) -->
          EOF

          echo "âœ… README.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: Commit and push README update
        run: |
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: update README with version v${{ steps.version.outputs.latest_version }} [skip ci]"
            git push origin main
          else
            echo "No README changes to commit."
          fi

      - name: Get PR Number and Merge
        run: |
          # workflow_runì—ì„œ PR ë²ˆí˜¸ ì¶”ì¶œ
          PR_NUMBER=$(gh api repos/${{ github.repository }}/pulls \
            --jq '.[] | select(.head.sha == "${{ github.event.workflow_run.head_sha }}") | .number' \
            | head -1)

          if [ -n "$PR_NUMBER" ]; then
            echo "ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. PR #$PR_NUMBERì„ ë³‘í•©í•©ë‹ˆë‹¤."
            gh pr merge $PR_NUMBER --squash --admin
          else
            echo "âš ï¸ PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìë™ ë³‘í•©ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: ğŸ‰ ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ
        run: |
          echo "ğŸ‰ ========================================"
          echo "ğŸ‰ ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
          echo "ğŸ‰ ========================================"
          echo "âœ… 1. ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          echo "âœ… 2. CHANGELOG ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "âœ… 3. TestFlight ë°°í¬ ì™„ë£Œ"
          echo "âœ… 4. README ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "âœ… 5. PR ë³‘í•© ì™„ë£Œ"
          echo ""
          echo "ğŸ“± ì•±ì´ TestFlightì—ì„œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤."
          echo "ğŸ“‹ ë‚´ë¶€ í…ŒìŠ¤í„°ì—ê²Œ ê³§ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤."
          echo "ğŸ‰ ========================================"
