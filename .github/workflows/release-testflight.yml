name: Release to TestFlight

on:
  pull_request_target:
    types: [opened, ready_for_review]
    branches:
      - 'release'

permissions:
  contents: write
  pull-requests: write

jobs:
  # ===============================================================
  # Job 1: Build Test
  # PRì˜ ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  # ===============================================================
  build-test:
    name: ğŸ§ª Build Test
    if: github.head_ref == 'main'
    runs-on: macos-14
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods -N
          cd ios && pod install --repo-update

      - name: Build iOS (Simulator)
        env:
          RCT_NO_LAUNCH_PACKAGER: '1'
        run: |
          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
            -derivedDataPath build \
            clean build

  # ===============================================================
  # Job 2: Prepare Release
  # ë²„ì „/ì²´ì¸ì§€ë¡œê·¸ ì—…ë°ì´íŠ¸, PR ë³‘í•© ë° Git íƒœê·¸ ìƒì„±ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
  # ===============================================================
  prepare-release:
    name: ğŸ“¦ Prepare Release
    needs: build-test
    runs-on: macos-14
    if: github.head_ref == 'main'
    outputs:
      new_version: ${{ steps.versioning.outputs.new_version }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }} # PAT í† í° ì‚¬ìš©
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Request CodeRabbit Summary
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "@coderabbitai review"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Wait for CodeRabbit Summary
        id: detect_summary
        timeout-minutes: 10
        run: |
          for i in {1..120}; do
            echo "[$i/120] Waiting for CodeRabbit summary..."
            PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq .body)
            if [[ "$PR_BODY" == *"Summary by CodeRabbit"* ]]; then
              echo "âœ… Summary found!"
              echo "$PR_BODY" > summary_section.html
              echo "summary_found=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "âš ï¸ Timed out waiting for summary."
          echo "summary_found=false" >> $GITHUB_OUTPUT
          exit 1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          chmod +x .github/scripts/rn_version_manager.sh
          chmod +x .github/scripts/changelog_manager.py

      - name: Increment version and sync native files
        id: versioning
        run: |
          NEW_VERSION=$(./.github/scripts/rn_version_manager.sh increment)
          ./.github/scripts/rn_version_manager.sh sync
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Changelog
        run: |
          python3 .github/scripts/changelog_manager.py update-from-summary
          python3 .github/scripts/changelog_manager.py generate-md
        env:
          VERSION: ${{ steps.versioning.outputs.new_version }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TIMESTAMP: ${{ github.event.pull_request.updated_at }}

      - name: Commit and push version updates
        run: |
          git add package.json ios/Wit/Info.plist android/app/build.gradle CHANGELOG.json CHANGELOG.md
          if ! git diff --staged --quiet; then
            git commit -m "chore: bump version to v${{ steps.versioning.outputs.new_version }} [skip ci]"
            git push origin main
          else
            echo "No version changes to commit."
          fi

      # PR ë³‘í•©ì€ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•œ í›„ì— ìˆ˜í–‰ë©ë‹ˆë‹¤ (update-readme jobì—ì„œ)

      - name: Create and push Git tag
        run: |
          git tag "v${{ steps.versioning.outputs.new_version }}"
          git push origin "v${{ steps.versioning.outputs.new_version }}"

      - name: Save Release Notes for deployment
        id: release_notes
        run: |
          # CHANGELOG.mdì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ë¶€ë¶„ë§Œ ì¶”ì¶œ
          awk '/## v${{ steps.versioning.outputs.new_version }}/{flag=1; next}/## v/{flag=0}flag' CHANGELOG.md > release_notes.txt
          cat release_notes.txt

      - name: Upload Release Notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.txt

  # ===============================================================
  # Job 3: Deploy to TestFlight
  # ì•±ì„ ë¹Œë“œí•˜ê³  TestFlightì— ë°°í¬í•©ë‹ˆë‹¤.
  # ===============================================================
  deploy-testflight:
    name: ğŸš€ Deploy to TestFlight
    needs: prepare-release
    runs-on: macos-14
    steps:
      - name: ğŸ“‹ Job ì‹œì‘ ë° í•„ìˆ˜ Secrets ê²€ì¦
        run: |
          echo "ğŸš€ ========================================"
          echo "ğŸš€ Deploy to TestFlight Job ì‹œì‘"
          echo "ğŸš€ ========================================"
          echo "ğŸ“… ì‹œì‘ ì‹œê°„: $(date)"
          echo "ğŸ”§ Runner OS: ${{ runner.os }}"
          echo "ğŸ’» Runner Architecture: ${{ runner.arch }}"
          echo "ğŸ“¦ í•„ìš”í•œ ë²„ì „ ì •ë³´: ${{ needs.prepare-release.outputs.new_version }}"
          echo ""
          echo "ğŸ” í•„ìˆ˜ GitHub Secrets ê²€ì¦:"

          # í•„ìˆ˜ Secrets ëª©ë¡
          MISSING_SECRETS=""

                              if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "âŒ APPLE_CERTIFICATE_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_CERTIFICATE_BASE64"
          else
            echo "âœ… APPLE_CERTIFICATE_BASE64"
          fi

          if [ -z "$APPLE_CERTIFICATE_PASSWORD" ]; then
            echo "âŒ APPLE_CERTIFICATE_PASSWORD ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_CERTIFICATE_PASSWORD"
          else
            echo "âœ… APPLE_CERTIFICATE_PASSWORD"
          fi

          if [ -z "$APPLE_PROVISIONING_PROFILE_BASE64" ]; then
            echo "âŒ APPLE_PROVISIONING_PROFILE_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_PROVISIONING_PROFILE_BASE64"
          else
            echo "âœ… APPLE_PROVISIONING_PROFILE_BASE64"
          fi

          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "âŒ APP_STORE_CONNECT_API_KEY_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_API_KEY_ID"
          else
            echo "âœ… APP_STORE_CONNECT_API_KEY_ID"
          fi

          if [ -z "$APP_STORE_CONNECT_ISSUER_ID" ]; then
            echo "âŒ APP_STORE_CONNECT_ISSUER_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_ISSUER_ID"
          else
            echo "âœ… APP_STORE_CONNECT_ISSUER_ID"
          fi

          if [ -z "$APP_STORE_CONNECT_API_KEY_BASE64" ]; then
            echo "âŒ APP_STORE_CONNECT_API_KEY_BASE64 ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APP_STORE_CONNECT_API_KEY_BASE64"
          else
            echo "âœ… APP_STORE_CONNECT_API_KEY_BASE64"
          fi

          if [ -z "$APPLE_ID" ]; then
            echo "âŒ APPLE_ID ëˆ„ë½"
            MISSING_SECRETS="$MISSING_SECRETS APPLE_ID"
          else
            echo "âœ… APPLE_ID: $APPLE_ID"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo ""
            echo "âŒ ========================================"
            echo "âŒ ëˆ„ë½ëœ GitHub Secrets:"
            for secret in $MISSING_SECRETS; do
              echo "  - $secret"
            done
            echo "âŒ ========================================"
            echo "í•´ê²° ë°©ë²•: GitHub ì €ì¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ ëˆ„ë½ëœ Secretsë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          echo ""
          echo "âœ… ëª¨ë“  í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸš€ ========================================"
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
      - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: release

      - name: âœ… ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“ í”„ë¡œì íŠ¸ íŒŒì¼ í™•ì¸:"
          ls -la | head -10
          echo "ğŸ“¦ package.json ë²„ì „ í™•ì¸:"
          node -p "require('./package.json').version"
          echo "âœ… ========================================"

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: âœ… Node.js ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Node.js ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ“¦ Node.js ë²„ì „: $(node --version)"
          echo "ğŸ“¦ npm ë²„ì „: $(npm --version)"
          echo "âœ… ========================================"

      - name: ğŸ“¦ JavaScript ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ ========================================"
          echo "ğŸ“¦ JavaScript ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ“¦ ========================================"
          npm ci
          echo "âœ… JavaScript ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          echo "ğŸ“Š ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ìˆ˜: $(ls node_modules | wc -l)"
          echo "ğŸ“¦ ========================================"

      - name: ğŸ Xcode ì„¤ì •
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: âœ… Xcode ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Xcode ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ Xcode ë²„ì „: $(xcodebuild -version)"
          echo "ğŸ ì‚¬ìš© ê°€ëŠ¥í•œ SDK:"
          xcodebuild -showsdks | grep iOS
          echo "âœ… ========================================"

      - name: ğŸ’ Ruby ì„¤ì •
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: âœ… Ruby ì„¤ì • ì™„ë£Œ
        run: |
          echo "âœ… ========================================"
          echo "âœ… Ruby ì„¤ì • ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ’ Ruby ë²„ì „: $(ruby --version)"
          echo "ğŸ’ Bundler ë²„ì „: $(bundle --version)"
          echo "âœ… ========================================"

      - name: ğŸ’ Fastlane ì„¤ì¹˜ (Bundle Install)
        run: |
          echo "ğŸ’ ========================================"
          echo "ğŸ’ Fastlane ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ’ ========================================"
          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ“‹ Gemfile ë‚´ìš© í™•ì¸:"
          cat Gemfile

          echo ""
          echo "ğŸ“¦ Bundle install ì‹¤í–‰ ì¤‘..."
          bundle install

          echo ""
          echo "âœ… Bundle install ì™„ë£Œ!"
          echo "ğŸ’ ì„¤ì¹˜ëœ Fastlane ë²„ì „: $(bundle exec fastlane --version | head -1)"
          echo "ğŸ’ ========================================"

      - name: ğŸ—ï¸ CocoaPods ì„¤ì¹˜
        run: |
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ—ï¸ CocoaPods ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ—ï¸ ========================================"
          gem install cocoapods -N
          echo "ğŸ“¦ CocoaPods ë²„ì „: $(pod --version)"
          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ Pod ì„¤ì¹˜..."
          cd ios && pod install --repo-update
          echo "âœ… CocoaPods ì„¤ì¹˜ ì™„ë£Œ"
          echo "ğŸ“Š ì„¤ì¹˜ëœ Pod ìˆ˜:"
          ls ios/Pods | grep -v "Headers\|Target" | wc -l
          echo "ğŸ—ï¸ ========================================"

      # ì¸ì¦ì„œ ì„¤ì¹˜ (ì•„ì¹´ì´ë¸Œ ë¹Œë“œì— í•„ìš”)
      - name: ğŸ” ì¸ì¦ì„œ ì„¤ì¹˜ ì‚¬ì „ ê²€ì¦
        run: |
          echo "ğŸ” ========================================"
          echo "ğŸ” Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜ ì‚¬ì „ ê²€ì¦"
          echo "ğŸ” ========================================"
          echo "ğŸ“‹ ì¸ì¦ì„œ ì„¤ì¹˜ ì „ í‚¤ì²´ì¸ ìƒíƒœ:"
          security list-keychains -d user
          echo ""
                    echo "ğŸ” GitHub Secrets ê²€ì¦:"
          if [ -z "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" ]; then
            echo "âŒ APPLE_CERTIFICATE_BASE64 Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… APPLE_CERTIFICATE_BASE64 Secret ì¡´ì¬í•¨"
            echo "ğŸ“Š ì¸ì¦ì„œ ë°ì´í„° ê¸¸ì´: ${#APPLE_CERTIFICATE_BASE64}"
          fi

          if [ -z "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" ]; then
            echo "âŒ APPLE_CERTIFICATE_PASSWORD Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… APPLE_CERTIFICATE_PASSWORD Secret ì¡´ì¬í•¨"
          fi
          echo "ğŸ” ========================================"
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}

      - name: ğŸ” Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          keychain: signing_temp
          create-keychain: true

      - name: âœ… ì¸ì¦ì„œ ì„¤ì¹˜ ì™„ë£Œ í™•ì¸
        run: |
          echo "âœ… ========================================"
          echo "âœ… Apple Distribution ì¸ì¦ì„œ ì„¤ì¹˜ ì™„ë£Œ"
          echo "âœ… ========================================"
          echo "ğŸ” ì„¤ì¹˜ëœ í‚¤ì²´ì¸ ëª©ë¡:"
          security list-keychains -d user
          echo ""
          echo "ğŸ” ì„¤ì¹˜ëœ ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ:"
          security find-identity -v -p codesigning
          echo ""
          echo "ğŸ” ê¸°ë³¸ í‚¤ì²´ì¸:"
          security default-keychain
          echo "âœ… ========================================"

      # í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
      - name: ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "ğŸ“± ========================================"
          echo "ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì‹œì‘"
          echo "ğŸ“± ========================================"

          echo "ğŸ“‚ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

          echo "ğŸ” Base64 í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì¤‘..."
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          echo "âœ… í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì™„ë£Œ"
          echo "ğŸ“Š ë””ì½”ë”©ëœ íŒŒì¼ í¬ê¸°: $(du -h profile.mobileprovision | cut -f1)"

          echo "ğŸ“‹ í”„ë¡œíŒŒì¼ ì •ë³´ ì¶”ì¶œ ì¤‘..."
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))

          echo "ğŸ“‹ ì¶”ì¶œëœ í”„ë¡œíŒŒì¼ ì •ë³´:"
          echo "  - UUID: $PROFILE_UUID"
          echo "  - Name: $PROFILE_NAME"

          # CLI í”„ë¡œì íŠ¸ìš© í”„ë¡œíŒŒì¼ì¸ì§€ í™•ì¸
          if [[ "$PROFILE_NAME" == *"expo"* ]]; then
            echo "âŒ ========================================"
            echo "âŒ ì—ëŸ¬: Expo í”„ë¡œíŒŒì¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "âŒ ========================================"
            echo "í˜„ì¬ í”„ë¡œíŒŒì¼: $PROFILE_NAME"
            echo ""
            echo "í•´ê²° ë°©ë²•:"
            echo "1. Apple Developer Consoleì—ì„œ CLI í”„ë¡œì íŠ¸ìš© Distribution í”„ë¡œíŒŒì¼ ìƒì„±"
            echo "2. í•´ë‹¹ í”„ë¡œíŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©"
            echo "3. GitHub Secretsì˜ APPLE_PROVISIONING_PROFILE_BASE64 ì—…ë°ì´íŠ¸"
            echo ""
            echo "CLI í”„ë¡œì íŠ¸ì—ëŠ” Expo í”„ë¡œíŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "âŒ ========================================"
            exit 1
          fi

          echo "ğŸ“‚ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì¤‘..."
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          echo "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" >> $GITHUB_ENV

          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì™„ë£Œ!"
          echo "ğŸ” ì„¤ì¹˜ëœ í”„ë¡œíŒŒì¼ í™•ì¸:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "ğŸ“± ========================================"

      - name: ğŸ“Š ë²„ì „ ì •ë³´ ìˆ˜ì§‘
        id: version
        run: |
          echo "ğŸ“Š ========================================"
          echo "ğŸ“Š ë²„ì „ ì •ë³´ ìˆ˜ì§‘ ì‹œì‘"
          echo "ğŸ“Š ========================================"

          VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER=$(git rev-list --count HEAD)

          echo "ğŸ“¦ ìˆ˜ì§‘ëœ ë²„ì „ ì •ë³´:"
          echo "  - ë²„ì „ëª…: $VERSION"
          echo "  - ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER"
          echo "  - Git ì»¤ë°‹ ìˆ˜: $(git rev-list --count HEAD)"
          echo "  - í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "  - ìµœì‹  ì»¤ë°‹: $(git log -1 --format='%h %s')"

          echo "version_name=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“Š ========================================"

      - name: ğŸ” ë¹Œë“œ í™˜ê²½ ë””ë²„ê¹…
        run: |
          echo "ğŸ” ========================================"
          echo "ğŸ” ë¹Œë“œ í™˜ê²½ ë””ë²„ê¹… ì‹œì‘"
          echo "ğŸ” ========================================"
          echo "ğŸ–¥ï¸ Runner ì •ë³´:"
          echo "  - Temp ë””ë ‰í† ë¦¬: ${{ runner.temp }}"
          echo "  - ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "  - ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: $(df -h . | tail -1)"

          echo ""
          echo "ğŸ” í‚¤ì²´ì¸ ìƒíƒœ:"
          echo "  - í˜„ì¬ í‚¤ì²´ì¸ ëª©ë¡:"
          security list-keychains -d user
          echo "  - ê¸°ë³¸ í‚¤ì²´ì¸:"
          security default-keychain

          echo ""
          echo "ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ìƒíƒœ:"
          echo "  - í™˜ê²½ ë³€ìˆ˜: $PROVISIONING_PROFILE_SPECIFIER"
          echo "  - ì„¤ì¹˜ëœ í”„ë¡œíŒŒì¼ ìˆ˜: $(ls ~/Library/MobileDevice/Provisioning\ Profiles/ | wc -l)"

          echo "ğŸ” ========================================"

      - name: ğŸ—ï¸ iOS ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
        run: |
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ—ï¸ iOS ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì‹œì‘"
          echo "ğŸ—ï¸ ========================================"

          echo "ğŸ” ë¹Œë“œ ì „ í™˜ê²½ í™•ì¸:"
          echo "  - ì„¤ì¹˜ëœ í‚¤ì²´ì¸:"
          security list-keychains -d user
          echo "  - ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ:"
          security find-identity -v -p codesigning

          echo ""
          echo "ğŸ“‹ ë¹Œë“œ ì„¤ì • ì •ë³´:"
          echo "  - í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼: ${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          echo "  - ì•± ë²„ì „: ${{ steps.version.outputs.version_name }}"
          echo "  - ë¹Œë“œ ë²ˆí˜¸: ${{ steps.version.outputs.build_number }}"
          echo "  - ì•„ì¹´ì´ë¸Œ ê²½ë¡œ: build/Wit.xcarchive"

          echo ""
          echo "ğŸš€ xcodebuild ì•„ì¹´ì´ë¸Œ ëª…ë ¹ ì‹¤í–‰ ì¤‘..."
          echo "ğŸ—ï¸ ========================================"

          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -archivePath build/Wit.xcarchive \
            -allowProvisioningUpdates \
            clean archive \
            CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
            MARKETING_VERSION=${{ steps.version.outputs.version_name }} \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"

          echo "ğŸ—ï¸ ========================================"
          echo "âœ… ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì™„ë£Œ!"
          echo "ğŸ—ï¸ ========================================"
          echo "ğŸ“ ìƒì„±ëœ ì•„ì¹´ì´ë¸Œ í™•ì¸:"
          if [ -d "build/Wit.xcarchive" ]; then
            echo "  âœ… ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì¡´ì¬í•¨"
            echo "  ğŸ“Š ì•„ì¹´ì´ë¸Œ í¬ê¸°: $(du -sh build/Wit.xcarchive | cut -f1)"
            echo "  ğŸ“‚ ì•„ì¹´ì´ë¸Œ ë‚´ìš©:"
            ls -la build/Wit.xcarchive/
          else
            echo "  âŒ ì•„ì¹´ì´ë¸Œ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "ğŸ—ï¸ ========================================"

      - name: ğŸ”‘ App Store Connect API Key ì„¤ì •
        run: |
          echo "ğŸ”‘ ========================================"
          echo "ğŸ”‘ App Store Connect API Key ì„¤ì • ì‹œì‘"
          echo "ğŸ”‘ ========================================"

          echo "ğŸ“‚ API Key ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p ~/.appstoreconnect/private_keys

          echo "ğŸ”“ API Key ë””ì½”ë”© ë° ì €ì¥ ì¤‘..."
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$API_KEY_PATH" >> $GITHUB_ENV

          echo "âœ… API Key ì„¤ì • ì™„ë£Œ!"
          echo "ğŸ“ API Key íŒŒì¼ í™•ì¸:"
          echo "  - ê²½ë¡œ: $API_KEY_PATH"
          echo "  - íŒŒì¼ ì¡´ì¬: $([ -f "$API_KEY_PATH" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - íŒŒì¼ í¬ê¸°: $([ -f "$API_KEY_PATH" ] && du -h "$API_KEY_PATH" | cut -f1 || echo "N/A")"
          echo "ğŸ”‘ ========================================"

      - name: ğŸ“¦ Fastlane ì‚¬ì „ ê²€ì¦
        run: |
          echo "ğŸ“¦ ========================================"
          echo "ğŸ“¦ Fastlane ì‚¬ì „ ê²€ì¦ ì‹œì‘"
          echo "ğŸ“¦ ========================================"

          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ” Fastlane ì„¤ì • íŒŒì¼ í™•ì¸:"
          if [ -f "fastlane/Fastfile" ]; then
            echo "  âœ… Fastfile ì¡´ì¬í•¨"
          else
            echo "  âŒ Fastfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi

          if [ -f "fastlane/Appfile" ]; then
            echo "  âœ… Appfile ì¡´ì¬í•¨"
          else
            echo "  âŒ Appfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi

          if [ -f "Gemfile" ]; then
            echo "  âœ… Gemfile ì¡´ì¬í•¨"
          else
            echo "  âŒ Gemfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo ""
          echo "ğŸ” Bundler ë° Fastlane ìƒíƒœ ì¬í™•ì¸:"
          echo "  - Bundler ë²„ì „: $(bundle --version)"

          # Fastlane ì„¤ì¹˜ ìƒíƒœ í™•ì¸
          if bundle exec fastlane --version > /dev/null 2>&1; then
            echo "  âœ… Fastlane ì„¤ì¹˜ í™•ì¸ë¨: $(bundle exec fastlane --version | head -1)"
          else
            echo "  âŒ Fastlaneì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "  ğŸ“¦ Bundle install ì¬ì‹¤í–‰ ì¤‘..."
            bundle install
            echo "  âœ… Bundle install ì™„ë£Œ"
          fi

          echo ""
          echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ Fastlane Lane í™•ì¸:"
          bundle exec fastlane lanes

          echo "ğŸ“¦ ========================================"

      - name: ğŸ“¦ Fastlane IPA ë‚´ë³´ë‚´ê¸°
        run: |
          echo "ğŸ“¦ ========================================"
          echo "ğŸ“¦ Fastlane IPA ë‚´ë³´ë‚´ê¸° ì‹œì‘"
          echo "ğŸ“¦ ========================================"

          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          export VERSION_NAME="${{ steps.version.outputs.version_name }}"
          export BUILD_NUMBER="${{ steps.version.outputs.build_number }}"
          export PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          export APP_STORE_CONNECT_API_KEY_PATH="${{ env.APP_STORE_CONNECT_API_KEY_PATH }}"
          export APPLE_ID="${{ secrets.APPLE_ID }}"

          echo "ğŸ” ì„¤ì •ëœ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  - VERSION_NAME: $VERSION_NAME"
          echo "  - BUILD_NUMBER: $BUILD_NUMBER"
          echo "  - PROVISIONING_PROFILE_SPECIFIER: $PROVISIONING_PROFILE_SPECIFIER"
          echo "  - API_KEY_PATH: $APP_STORE_CONNECT_API_KEY_PATH"
          echo "  - APPLE_ID: $APPLE_ID"

          echo ""
          echo "ğŸ“‹ Fastlane ì‹¤í–‰ ì „ ìµœì¢… í™•ì¸:"
          echo "ğŸ” ì•„ì¹´ì´ë¸Œ íŒŒì¼ ìœ„ì¹˜ ë””ë²„ê¹…:"
          echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "  - ../build/Wit.xcarchive ì¡´ì¬: $([ -d "../build/Wit.xcarchive" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - build/Wit.xcarchive ì¡´ì¬: $([ -d "build/Wit.xcarchive" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la
          echo "  - ìƒìœ„ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la ..
          echo "  - build ë””ë ‰í† ë¦¬ í™•ì¸:"
          if [ -d "../build" ]; then
            echo "    âœ… ../build ë””ë ‰í† ë¦¬ ì¡´ì¬"
            ls -la ../build/
          else
            echo "    âŒ ../build ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          if [ -d "build" ]; then
            echo "    âœ… ./build ë””ë ‰í† ë¦¬ ì¡´ì¬"  
            ls -la build/
          else
            echo "    âŒ ./build ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          # ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì¡´ì¬ í™•ì¸ (ìœ ì—°í•˜ê²Œ)
          archive_found=false
          if [ -d "../build/Wit.xcarchive" ]; then
            echo "  âœ… ì•„ì¹´ì´ë¸Œ íŒŒì¼ ë°œê²¬: ../build/Wit.xcarchive"
            archive_found=true
          elif [ -d "build/Wit.xcarchive" ]; then
            echo "  âœ… ì•„ì¹´ì´ë¸Œ íŒŒì¼ ë°œê²¬: build/Wit.xcarchive"
            archive_found=true
          fi

          if [ "$archive_found" = false ]; then
            echo "âŒ ì•„ì¹´ì´ë¸Œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Fastlaneì—ì„œ ìì²´ ì§„ë‹¨ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            echo "âš ï¸  Fastlaneì´ ì•„ì¹´ì´ë¸Œë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ìƒì„¸í•œ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì¶œë ¥í•  ê²ƒì…ë‹ˆë‹¤."
          fi

                              echo ""
          echo "ğŸ” ========================================"
          echo "ğŸ” ì½”ë“œ ì‚¬ì´ë‹ ìƒíƒœ ìµœì¢… ì ê²€"
          echo "ğŸ” ========================================"

          echo "ğŸ” í‚¤ì²´ì¸ ìƒíƒœ í™•ì¸:"
          security list-keychains -d user

          echo ""
          echo "ğŸ” ì„¤ì¹˜ëœ ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ í™•ì¸:"
          # ëª¨ë“  í‚¤ì²´ì¸ì—ì„œ ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ ì°¾ê¸°
          for keychain in $(security list-keychains -d user | tr -d '"'); do
            if [ -f "$keychain" ]; then
              echo "  ğŸ“‹ í‚¤ì²´ì¸: $keychain"
              security find-identity -v -p codesigning "$keychain" 2>/dev/null || echo "    âŒ ì½”ë“œ ì‚¬ì´ë‹ ì¸ì¦ì„œ ì—†ìŒ"
            fi
          done

          echo ""
          echo "ğŸ” í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ í™•ì¸:"
          echo "  - ì§€ì •ëœ í”„ë¡œíŒŒì¼: $PROVISIONING_PROFILE_SPECIFIER"

          # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ profile.mobileprovision í™•ì¸
          if [ -f "profile.mobileprovision" ]; then
            echo "  âœ… profile.mobileprovision íŒŒì¼ ì¡´ì¬ (í˜„ì¬ ë””ë ‰í† ë¦¬)"
            echo "  ğŸ“‹ í”„ë¡œíŒŒì¼ ì •ë³´:"
            security cms -D -i profile.mobileprovision 2>/dev/null | grep -E "Name|TeamName|UUID|TeamIdentifier" | head -10 || echo "    âŒ í”„ë¡œíŒŒì¼ ì •ë³´ ì½ê¸° ì‹¤íŒ¨"
          else
            echo "  âŒ profile.mobileprovision íŒŒì¼ ì—†ìŒ (í˜„ì¬ ë””ë ‰í† ë¦¬)"
          fi

          # ìƒìœ„ ë””ë ‰í† ë¦¬ì˜ profile.mobileprovision í™•ì¸
          if [ -f "../profile.mobileprovision" ]; then
            echo "  âœ… profile.mobileprovision íŒŒì¼ ì¡´ì¬ (ìƒìœ„ ë””ë ‰í† ë¦¬)"
            echo "  ğŸ“‹ ìƒìœ„ ë””ë ‰í† ë¦¬ í”„ë¡œíŒŒì¼ ì •ë³´:"
            security cms -D -i ../profile.mobileprovision 2>/dev/null | grep -E "Name|TeamName|UUID|TeamIdentifier" | head -10 || echo "    âŒ í”„ë¡œíŒŒì¼ ì •ë³´ ì½ê¸° ì‹¤íŒ¨"
          else
            echo "  âŒ profile.mobileprovision íŒŒì¼ ì—†ìŒ (ìƒìœ„ ë””ë ‰í† ë¦¬)"
          fi

          echo ""
          echo "ğŸ” ~/Library/MobileDevice/Provisioning\ Profiles/ í™•ì¸:"
          if [ -d ~/Library/MobileDevice/Provisioning\ Profiles/ ]; then
            echo "  ğŸ“‚ ì„¤ì¹˜ëœ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°œìˆ˜: $(ls ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision 2>/dev/null | wc -l)"
            ls -la ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision 2>/dev/null | head -5 || echo "    âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì—†ìŒ"
          else
            echo "  âŒ í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

          echo "ğŸ” ========================================"

          echo ""
          echo "ğŸš€ Fastlane build_and_export ì‹¤í–‰ ì¤‘..."
          echo "ğŸ“¦ ========================================"

          # Fastlane ì‹¤í–‰ ì „ ë§ˆì§€ë§‰ ì•ˆì „ í™•ì¸
          if ! bundle exec fastlane --version > /dev/null 2>&1; then
            echo "âŒ Fastlane ì‹¤í–‰ ë¶ˆê°€! Bundle install ì¬ì‹¤í–‰..."
            bundle install
          fi

          bundle exec fastlane build_and_export

          echo "ğŸ“¦ ========================================"
          echo "âœ… Fastlane IPA ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!"
          echo "ğŸ“¦ ========================================"
                    echo "ğŸ“ ìƒì„±ëœ IPA íŒŒì¼ í™•ì¸:"
          echo "ğŸ” IPA íŒŒì¼ ìœ„ì¹˜ ìƒì„¸ ë””ë²„ê¹…:"

          # ê°€ëŠ¥í•œ ëª¨ë“  IPA ê²½ë¡œ í™•ì¸
          possible_ipa_paths=(
            "../build/ipa/Wit.ipa"
            "build/ipa/Wit.ipa"
            "../build/ipa/*.ipa"
            "build/ipa/*.ipa"
          )

          possible_ipa_dirs=(
            "../build/ipa"
            "build/ipa"
            "../build"
            "build"
          )

          echo "ğŸ” IPA ë””ë ‰í† ë¦¬ í™•ì¸:"
          for dir in "${possible_ipa_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "  âœ… ë””ë ‰í† ë¦¬ ì¡´ì¬: $dir"
              echo "    ğŸ“‚ ë‚´ìš©:"
              ls -la "$dir" | head -10
            else
              echo "  âŒ ë””ë ‰í† ë¦¬ ì—†ìŒ: $dir"
            fi
          done

          echo ""
          echo "ğŸ” IPA íŒŒì¼ ê²€ìƒ‰:"
          ipa_found=false
          found_ipa_path=""

          for path in "${possible_ipa_paths[@]}"; do
            if [[ "$path" == *"*"* ]]; then
              # ì™€ì¼ë“œì¹´ë“œ íŒ¨í„´ ì²˜ë¦¬
              for file in $path; do
                if [ -f "$file" ]; then
                  echo "  âœ… IPA íŒŒì¼ ë°œê²¬: $file"
                  echo "    ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$file" | cut -f1)"
                  echo "    ğŸ“… ìƒì„± ì‹œê°„: $(stat -f "%Sm" "$file")"
                  ipa_found=true
                  found_ipa_path="$file"
                  break 2
                fi
              done
            else
              if [ -f "$path" ]; then
                echo "  âœ… IPA íŒŒì¼ ë°œê²¬: $path"
                echo "    ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$path" | cut -f1)"
                echo "    ğŸ“… ìƒì„± ì‹œê°„: $(stat -f "%Sm" "$path")"
                ipa_found=true
                found_ipa_path="$path"
                break
              else
                echo "  âŒ IPA íŒŒì¼ ì—†ìŒ: $path"
              fi
            fi
          done

          if [ "$ipa_found" = false ]; then
            echo ""
            echo "âš ï¸  ì§ì ‘ ê²½ë¡œì—ì„œ IPAë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì „ì²´ build ë””ë ‰í† ë¦¬ íƒìƒ‰ ì¤‘..."
            
            # ì „ì²´ build ë””ë ‰í† ë¦¬ì—ì„œ .ipa íŒŒì¼ ê²€ìƒ‰
            if [ -d "../build" ]; then
              echo "ğŸ” ../build ë””ë ‰í† ë¦¬ ì „ì²´ íƒìƒ‰:"
              find ../build -name "*.ipa" -type f 2>/dev/null | while read -r ipa_file; do
                echo "  ğŸ¯ ë°œê²¬ëœ IPA: $ipa_file"
                echo "    ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$ipa_file" | cut -f1)"
                ipa_found=true
                found_ipa_path="$ipa_file"
              done
            fi
            
            if [ -d "build" ]; then
              echo "ğŸ” ./build ë””ë ‰í† ë¦¬ ì „ì²´ íƒìƒ‰:"
              find build -name "*.ipa" -type f 2>/dev/null | while read -r ipa_file; do
                echo "  ğŸ¯ ë°œê²¬ëœ IPA: $ipa_file"
                echo "    ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$ipa_file" | cut -f1)"
                ipa_found=true
                found_ipa_path="$ipa_file"
              done
            fi
          fi

          if [ "$ipa_found" = true ]; then
            echo ""
            echo "âœ… IPA íŒŒì¼ í™•ì¸ ì™„ë£Œ!"
            echo "ğŸ“¦ ìµœì¢… IPA ê²½ë¡œ: $found_ipa_path"
          else
            echo ""
            echo "âŒ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
            echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "  - ì „ì²´ build êµ¬ì¡°:"
            if [ -d "../build" ]; then
              find ../build -type f -name "*" 2>/dev/null | head -20
            fi
            if [ -d "build" ]; then
              find build -type f -name "*" 2>/dev/null | head -20
            fi
            echo ""
            echo "âš ï¸  IPA ìƒì„±ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ì›Œí¬í”Œë¡œìš°ë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
            echo "   TestFlight ì—…ë¡œë“œ ë‹¨ê³„ì—ì„œ ë‹¤ì‹œ í•œ ë²ˆ IPA ê²€ìƒ‰ì„ ì‹œë„í•©ë‹ˆë‹¤."
          fi
          echo "ğŸ“¦ ========================================"

      - name: Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Read changelog file for TestFlight
        id: read_changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ” TestFlight ì—…ë¡œë“œ ì „ IPA íŒŒì¼ ì§€ëŠ¥í˜• ê²€ìƒ‰
        run: |
          echo "ğŸ” ========================================"
          echo "ğŸ” TestFlight ì—…ë¡œë“œ ì „ IPA íŒŒì¼ ì§€ëŠ¥í˜• ê²€ìƒ‰"
          echo "ğŸ” ========================================"

          cd ios
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

          # ê°€ëŠ¥í•œ ëª¨ë“  IPA ê²½ë¡œ ì •ì˜
          possible_ipa_locations=(
            "../build/ipa/Wit.ipa"
            "build/ipa/Wit.ipa"
            "../build/ipa/*.ipa"
            "build/ipa/*.ipa"
          )

          final_ipa_path=""

          echo "ğŸ” ì •ì˜ëœ ê²½ë¡œì—ì„œ IPA ê²€ìƒ‰ ì¤‘..."
          for location in "${possible_ipa_locations[@]}"; do
            echo "  ğŸ“ í™•ì¸ ì¤‘: $location"
            if [[ "$location" == *"*"* ]]; then
              # ì™€ì¼ë“œì¹´ë“œ íŒ¨í„´
              for file in $location; do
                if [ -f "$file" ] && [[ "$file" == *.ipa ]]; then
                  echo "  âœ… ë°œê²¬: $file"
                  final_ipa_path="$file"
                  break 2
                fi
              done
            else
              if [ -f "$location" ]; then
                echo "  âœ… ë°œê²¬: $location"
                final_ipa_path="$location"
                break
              fi
            fi
          done

          # ì •ì˜ëœ ê²½ë¡œì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ì „ì²´ ê²€ìƒ‰
          if [ -z "$final_ipa_path" ]; then
            echo ""
            echo "âš ï¸  ì •ì˜ëœ ê²½ë¡œì—ì„œ IPAë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            echo "ğŸ” ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°ì—ì„œ .ipa íŒŒì¼ ê²€ìƒ‰ ì¤‘..."
            
            # findë¥¼ ì‚¬ìš©í•œ ì „ì²´ ê²€ìƒ‰
            search_dirs=("../build" "build" ".." ".")
            for search_dir in "${search_dirs[@]}"; do
              if [ -d "$search_dir" ]; then
                echo "  ğŸ” $search_dir ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ì¤‘..."
                found_files=$(find "$search_dir" -name "*.ipa" -type f 2>/dev/null | head -5)
                if [ -n "$found_files" ]; then
                  echo "$found_files" | while read -r found_file; do
                    echo "    ğŸ¯ ë°œê²¬: $found_file"
                    if [ -z "$final_ipa_path" ]; then
                      final_ipa_path="$found_file"
                    fi
                  done
                  # ì²« ë²ˆì§¸ ë°œê²¬ëœ íŒŒì¼ ì‚¬ìš©
                  final_ipa_path=$(echo "$found_files" | head -1)
                  break
                fi
              fi
            done
          fi

          # ìµœì¢… ê²°ê³¼ í™•ì¸
          if [ -n "$final_ipa_path" ] && [ -f "$final_ipa_path" ]; then
            echo ""
            echo "âœ… ========================================"
            echo "âœ… IPA íŒŒì¼ ê²€ìƒ‰ ì„±ê³µ!"
            echo "âœ… ========================================"
            echo "ğŸ“¦ ìµœì¢… IPA ê²½ë¡œ: $final_ipa_path"
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$final_ipa_path" | cut -f1)"
            echo "ğŸ“… ìƒì„± ì‹œê°„: $(stat -f "%Sm" "$final_ipa_path" 2>/dev/null || stat -c "%y" "$final_ipa_path" 2>/dev/null || echo "Unknown")"
            echo "ğŸ”’ íŒŒì¼ ê¶Œí•œ: $(ls -l "$final_ipa_path" | cut -d' ' -f1)"
            
            # í™˜ê²½ ë³€ìˆ˜ë¡œ ê²½ë¡œ ì €ì¥
            echo "FINAL_IPA_PATH=$final_ipa_path" >> $GITHUB_ENV
            
            # íŒŒì¼ ë¬´ê²°ì„± ê²€ì‚¬
            if file "$final_ipa_path" | grep -q "Zip archive"; then
              echo "âœ… IPA íŒŒì¼ í˜•ì‹ ê²€ì¦ í†µê³¼ (Zip archive)"
            else
              echo "âš ï¸  IPA íŒŒì¼ í˜•ì‹ ê²½ê³ : $(file "$final_ipa_path")"
            fi
            
          else
            echo ""
            echo "âŒ ========================================"
            echo "âŒ IPA íŒŒì¼ ê²€ìƒ‰ ì‹¤íŒ¨!"
            echo "âŒ ========================================"
            echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
            echo "  - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "  - ê²€ìƒ‰í•œ ìœ„ì¹˜ë“¤:"
            for location in "${possible_ipa_locations[@]}"; do
              echo "    - $location"
            done
            echo ""
            echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
            find . -type f -name "*" 2>/dev/null | head -30
            echo ""
            echo "âš ï¸  IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ì„œ TestFlight ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "SKIP_TESTFLIGHT_UPLOAD=true" >> $GITHUB_ENV
          fi

          echo "ğŸ” ========================================"

      - name: ğŸš€ Fastlane TestFlight ì—…ë¡œë“œ
        run: |
          echo "ğŸš€ ========================================"
          echo "ğŸš€ Fastlane TestFlight ì—…ë¡œë“œ ì‹œì‘"
          echo "ğŸš€ ========================================"

          # TestFlight ì—…ë¡œë“œ ê±´ë„ˆë›°ê¸° í™•ì¸
          if [ "${{ env.SKIP_TESTFLIGHT_UPLOAD }}" = "true" ]; then
            echo "âš ï¸  IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ì„œ TestFlight ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "ğŸš€ ========================================"
            exit 0
          fi

          echo "ğŸ“‚ iOS ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘..."
          cd ios

          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          export CHANGELOG="${{ steps.read_changelog.outputs.changelog }}"
          export APP_STORE_CONNECT_API_KEY_PATH="${{ env.APP_STORE_CONNECT_API_KEY_PATH }}"
          export APPLE_ID="${{ secrets.APPLE_ID }}"
          export FINAL_IPA_PATH="${{ env.FINAL_IPA_PATH }}"

          echo "ğŸ” ì—…ë¡œë“œ ì¤€ë¹„ ìƒíƒœ í™•ì¸:"
          echo "  - ìµœì¢… IPA ê²½ë¡œ: $FINAL_IPA_PATH"
          echo "  - IPA íŒŒì¼ ì¡´ì¬: $([ -f "$FINAL_IPA_PATH" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - API Key íŒŒì¼ ì¡´ì¬: $([ -f "$APP_STORE_CONNECT_API_KEY_PATH" ] && echo "âœ… ì˜ˆ" || echo "âŒ ì•„ë‹ˆì˜¤")"
          echo "  - Apple ID: $APPLE_ID"

          # IPA íŒŒì¼ ìµœì¢… í™•ì¸
          if [ -z "$FINAL_IPA_PATH" ] || [ ! -f "$FINAL_IPA_PATH" ]; then
            echo "âŒ ìµœì¢… IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ” ë§ˆì§€ë§‰ ì‹œë„: í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ IPA ì¬ê²€ìƒ‰..."
            
            # ë§ˆì§€ë§‰ ì‹œë„ë¡œ í˜„ì¬ ìœ„ì¹˜ì—ì„œ IPA ê²€ìƒ‰
            last_chance_ipa=$(find .. -name "*.ipa" -type f 2>/dev/null | head -1)
            if [ -n "$last_chance_ipa" ] && [ -f "$last_chance_ipa" ]; then
              echo "ğŸ¯ ë§ˆì§€ë§‰ ì‹œë„ ì„±ê³µ! IPA ë°œê²¬: $last_chance_ipa"
              export FINAL_IPA_PATH="$last_chance_ipa"
            else
              echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨. TestFlight ì—…ë¡œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              echo "ğŸš€ ========================================"
              exit 1
            fi
          fi

          echo ""
          echo "ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (ë³€ê²½ì‚¬í•­):"
          echo "----------------------------------------"
          echo "$CHANGELOG"
          echo "----------------------------------------"

          echo ""
          echo "ğŸš€ Fastlane upload_testflight ì‹¤í–‰ ì¤‘..."
          echo "ğŸš€ ========================================"

          # Fastlane ì‹¤í–‰ ì „ ë§ˆì§€ë§‰ ì•ˆì „ í™•ì¸
          if ! bundle exec fastlane --version > /dev/null 2>&1; then
            echo "âŒ Fastlane ì‹¤í–‰ ë¶ˆê°€! Bundle install ì¬ì‹¤í–‰..."
            bundle install
          fi

          # Fastlaneì— IPA ê²½ë¡œ ì „ë‹¬
          export IPA_PATH="$FINAL_IPA_PATH"
          bundle exec fastlane upload_testflight

          echo "ğŸš€ ========================================"
          echo "âœ… Fastlane TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
          echo "ğŸš€ ========================================"

      - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ë¡œê·¸
        run: |
          echo "ğŸ‰ ========================================"
          echo "ğŸ‰ TestFlight ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ‰ ========================================"
          echo "ğŸ“± ì•±ì´ TestFlightì— ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“… ë°°í¬ ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ğŸ“¦ ë°°í¬ëœ ë²„ì „: ${{ steps.version.outputs.version_name }}"
          echo "ğŸ”¢ ë¹Œë“œ ë²ˆí˜¸: ${{ steps.version.outputs.build_number }}"
          echo ""
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
          echo "  1. TestFlightì—ì„œ ë¹Œë“œ ì²˜ë¦¬ ì™„ë£Œ ëŒ€ê¸°"
          echo "  2. ë‚´ë¶€ í…ŒìŠ¤í„°ì—ê²Œ ì•Œë¦¼ ë°œì†¡"
          echo "  3. í…ŒìŠ¤íŠ¸ ì§„í–‰ í›„ App Store ì¶œì‹œ ì¤€ë¹„"
          echo "ğŸ‰ ========================================"

  # ===============================================================
  # Job 4: Update README
  # ë°°í¬ ì™„ë£Œ í›„ main ë¸Œëœì¹˜ì˜ README íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
  # ===============================================================
  update-readme:
    name: ğŸ“ Update README
    needs: deploy-testflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get latest version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "latest_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update README.md
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d')
          VERSION_TEXT="v${{ steps.version.outputs.latest_version }} ($TIMESTAMP)"
          # READMEì—ì„œ ë²„ì „ ë¼ì¸ì„ ì°¾ì•„ ì—…ë°ì´íŠ¸ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
          sed -i -E "s/^(##\\s*(ìµœì‹ |Current|Recent|Latest)?\\s*ë²„ì „\\s*:\\s*).*/\\1${VERSION_TEXT}/i" README.md

      - name: Commit and push README update
        run: |
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: update README with version v${{ steps.version.outputs.latest_version }} [skip ci]"
            git push origin main
          else
            echo "No README changes to commit."
          fi

      - name: Merge PR to release branch
        run: |
          echo "ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. PRì„ ë³‘í•©í•©ë‹ˆë‹¤."
          gh pr merge ${{ github.event.pull_request.number }} --squash --admin
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
