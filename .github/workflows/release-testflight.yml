name: Release to TestFlight

on:
  pull_request_target:
    types: [opened, ready_for_review]
    branches:
      - 'release'

permissions:
  contents: write
  pull-requests: write

jobs:
  # ===============================================================
  # Job 1: Build Test
  # PRì˜ ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  # ===============================================================
  build-test:
    name: ğŸ§ª Build Test
    if: github.head_ref == 'main'
    runs-on: macos-14
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods -N
          cd ios && pod install --repo-update

      - name: Build iOS (Simulator)
        env:
          RCT_NO_LAUNCH_PACKAGER: '1'
        run: |
          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
            -derivedDataPath build \
            clean build

  # ===============================================================
  # Job 2: Prepare Release
  # ë²„ì „/ì²´ì¸ì§€ë¡œê·¸ ì—…ë°ì´íŠ¸, PR ë³‘í•© ë° Git íƒœê·¸ ìƒì„±ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
  # ===============================================================
  prepare-release:
    name: ğŸ“¦ Prepare Release
    needs: build-test
    runs-on: macos-14
    if: github.head_ref == 'main'
    outputs:
      new_version: ${{ steps.versioning.outputs.new_version }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }} # PAT í† í° ì‚¬ìš©
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Request CodeRabbit Summary
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "@coderabbitai review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CodeRabbit Summary
        id: detect_summary
        timeout-minutes: 10
        run: |
          for i in {1..120}; do
            echo "[$i/120] Waiting for CodeRabbit summary..."
            PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq .body)
            if [[ "$PR_BODY" == *"Summary by CodeRabbit"* ]]; then
              echo "âœ… Summary found!"
              echo "$PR_BODY" > summary_section.html
              echo "summary_found=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "âš ï¸ Timed out waiting for summary."
          echo "summary_found=false" >> $GITHUB_OUTPUT
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          chmod +x .github/scripts/rn_version_manager.sh
          chmod +x .github/scripts/changelog_manager.py

      - name: Increment version and sync native files
        id: versioning
        run: |
          NEW_VERSION=$(./.github/scripts/rn_version_manager.sh increment)
          ./.github/scripts/rn_version_manager.sh sync
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Changelog
        run: |
          python3 .github/scripts/changelog_manager.py update-from-summary
          python3 .github/scripts/changelog_manager.py generate-md
        env:
          VERSION: ${{ steps.versioning.outputs.new_version }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TIMESTAMP: ${{ github.event.pull_request.updated_at }}

      - name: Commit and push version updates
        run: |
          git add package.json ios/Wit/Info.plist android/app/build.gradle CHANGELOG.json CHANGELOG.md
          if ! git diff --staged --quiet; then
            git commit -m "chore: bump version to v${{ steps.versioning.outputs.new_version }} [skip ci]"
            git push origin main
          else
            echo "No version changes to commit."
          fi

      # PR ë³‘í•©ì€ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•œ í›„ì— ìˆ˜í–‰ë©ë‹ˆë‹¤ (update-readme jobì—ì„œ)

      - name: Create and push Git tag
        run: |
          git tag "v${{ steps.versioning.outputs.new_version }}"
          git push origin "v${{ steps.versioning.outputs.new_version }}"

      - name: Save Release Notes for deployment
        id: release_notes
        run: |
          # CHANGELOG.mdì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ë¶€ë¶„ë§Œ ì¶”ì¶œ
          awk '/## v${{ steps.versioning.outputs.new_version }}/{flag=1; next}/## v/{flag=0}flag' CHANGELOG.md > release_notes.txt
          cat release_notes.txt

      - name: Upload Release Notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.txt

  # ===============================================================
  # Job 3: Deploy to TestFlight
  # ì•±ì„ ë¹Œë“œí•˜ê³  TestFlightì— ë°°í¬í•©ë‹ˆë‹¤.
  # ===============================================================
  deploy-testflight:
    name: ğŸš€ Deploy to TestFlight
    needs: prepare-release
    runs-on: macos-14
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods -N
          cd ios && pod install --repo-update

      # Fastlane ì‚¬ìš© ì‹œ ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ì„¤ì •ì€ Fastlaneì´ ìë™ ì²˜ë¦¬
      - name: Setup Fastlane Match (Alternative)
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì‹œì‘..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

          echo "ğŸ” Base64 í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì¤‘..."
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          echo "âœ… í”„ë¡œíŒŒì¼ ë””ì½”ë”© ì™„ë£Œ"

          echo "ğŸ“‹ í”„ë¡œíŒŒì¼ ì •ë³´ ì¶”ì¶œ ì¤‘..."
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))

          echo "ğŸ“‹ í”„ë¡œíŒŒì¼ ì •ë³´:"
          echo "  - UUID: $PROFILE_UUID"
          echo "  - Name: $PROFILE_NAME"

          # CLI í”„ë¡œì íŠ¸ìš© í”„ë¡œíŒŒì¼ì¸ì§€ í™•ì¸
          if [[ "$PROFILE_NAME" == *"expo"* ]]; then
            echo "âŒ ì—ëŸ¬: Expo í”„ë¡œíŒŒì¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "í˜„ì¬ í”„ë¡œíŒŒì¼: $PROFILE_NAME"
            echo ""
            echo "í•´ê²° ë°©ë²•:"
            echo "1. Apple Developer Consoleì—ì„œ CLI í”„ë¡œì íŠ¸ìš© Distribution í”„ë¡œíŒŒì¼ ìƒì„±"
            echo "2. í•´ë‹¹ í”„ë¡œíŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©"
            echo "3. GitHub Secretsì˜ APPLE_PROVISIONING_PROFILE_BASE64 ì—…ë°ì´íŠ¸"
            echo ""
            echo "CLI í”„ë¡œì íŠ¸ì—ëŠ” Expo í”„ë¡œíŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ“‚ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì¤‘..."
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          echo "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" >> $GITHUB_ENV

          echo "âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜ ì™„ë£Œ!"
          echo "ğŸ” ì„¤ì¹˜ëœ í”„ë¡œíŒŒì¼ í™•ì¸:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Get Version Info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "version_name=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Debug Keychain and Environment
        run: |
          echo "ğŸ” í™˜ê²½ ë””ë²„ê¹… ì‹œì‘..."
          echo "Runner temp directory: ${{ runner.temp }}"
          echo "ì„ì‹œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la ${{ runner.temp }}/
          echo ""
          echo "í˜„ì¬ í‚¤ì²´ì¸ ëª©ë¡:"
          security list-keychains -d user
          echo ""
          echo "ê¸°ë³¸ í‚¤ì²´ì¸:"
          security default-keychain
          echo ""

      - name: Build and Archive iOS
        run: |
          echo "ğŸ—ï¸ iOS ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì‹œì‘..."

          # ì‹¤ì œ ìƒì„±ëœ í‚¤ì²´ì¸ ì°¾ê¸°
          echo "ğŸ” ìƒì„±ëœ í‚¤ì²´ì¸ ì°¾ëŠ” ì¤‘..."
          security list-keychains -d user

          # Apple-Actionsê°€ ìƒì„±í•œ í‚¤ì²´ì¸ ê²½ë¡œ ì°¾ê¸° (ë¡œê·¸ì—ì„œ í™•ì¸ëœ ê²½ë¡œ ì‚¬ìš©)
          KEYCHAIN_PATH="/Users/runner/Library/Keychains/signing_temp.keychain-db"

          if [ ! -f "$KEYCHAIN_PATH" ]; then
            echo "âŒ signing_temp í‚¤ì²´ì¸ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ì²´ì¸ ëª©ë¡:"
            security list-keychains -d user
            
            # ë‹¤ë¥¸ ê°€ëŠ¥í•œ í‚¤ì²´ì¸ ì°¾ê¸°
            ALTERNATIVE_KEYCHAIN=$(security list-keychains -d user | grep -v "login.keychain" | head -1 | tr -d '"' | xargs)
            if [ -n "$ALTERNATIVE_KEYCHAIN" ] && [ -f "$ALTERNATIVE_KEYCHAIN" ]; then
              KEYCHAIN_PATH="$ALTERNATIVE_KEYCHAIN"
              echo "âœ… ëŒ€ì•ˆ í‚¤ì²´ì¸ ì‚¬ìš©: $KEYCHAIN_PATH"
            else
              echo "âŒ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ì²´ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              exit 1
            fi
          fi

          echo "âœ… í‚¤ì²´ì¸ íŒŒì¼ í™•ì¸ë¨: $KEYCHAIN_PATH"

          # í‚¤ì²´ì¸ ì„¤ì •
          echo "ğŸ” í‚¤ì²´ì¸ ì„¤ì • ì¤‘..."
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          echo "âœ… í‚¤ì²´ì¸ ì„¤ì • ì™„ë£Œ"

          # ì½”ë“œ ì‚¬ì´ë‹ ID í™•ì¸
          echo "ğŸ” ì½”ë“œ ì‚¬ì´ë‹ ID í™•ì¸ ì¤‘..."
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "ğŸ“± í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼: ${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          echo "ğŸ“¦ ë²„ì „: ${{ steps.version.outputs.version_name }}"
          echo "ğŸ”¢ ë¹Œë“œ ë²ˆí˜¸: ${{ steps.version.outputs.build_number }}"

          echo "ğŸš€ xcodebuild ì•„ì¹´ì´ë¸Œ ì‹œì‘..."
          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -archivePath build/Wit.xcarchive \
            -allowProvisioningUpdates \
            clean archive \
            CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
            MARKETING_VERSION=${{ steps.version.outputs.version_name }} \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"

          echo "âœ… ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì™„ë£Œ!"

      - name: Setup App Store Connect API Key
        run: |
          echo "ğŸ”‘ App Store Connect API Key ì„¤ì • ì¤‘..."
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          echo "APP_STORE_CONNECT_API_KEY_PATH=$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8" >> $GITHUB_ENV
          echo "âœ… API Key ì„¤ì • ì™„ë£Œ"

      - name: Export IPA with Fastlane
        run: |
          echo "ğŸ“¦ Fastlaneì„ ì‚¬ìš©í•œ IPA ë‚´ë³´ë‚´ê¸° ì‹œì‘..."
          cd ios

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export VERSION_NAME="${{ steps.version.outputs.version_name }}"
          export BUILD_NUMBER="${{ steps.version.outputs.build_number }}"
          export PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          export APP_STORE_CONNECT_API_KEY_PATH="${{ env.APP_STORE_CONNECT_API_KEY_PATH }}"
          export APPLE_ID="${{ secrets.APPLE_ID }}"

          echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  - VERSION_NAME: $VERSION_NAME"
          echo "  - BUILD_NUMBER: $BUILD_NUMBER"
          echo "  - PROVISIONING_PROFILE_SPECIFIER: $PROVISIONING_PROFILE_SPECIFIER"
          echo "  - API_KEY_PATH: $APP_STORE_CONNECT_API_KEY_PATH"

          # Fastlane ì‹¤í–‰
          bundle exec fastlane build_and_export

          echo "âœ… Fastlane IPA ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!"
          echo "ìƒì„±ëœ IPA íŒŒì¼:"
          ls -la ../build/ipa/

      - name: Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Read changelog file for TestFlight
        id: read_changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Verify IPA before Upload
        run: |
          echo "ğŸ” TestFlight ì—…ë¡œë“œ ì „ IPA íŒŒì¼ í™•ì¸..."
          IPA_PATH="build/ipa/Wit.ipa"

          if [ ! -f "$IPA_PATH" ]; then
            echo "âŒ IPA íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $IPA_PATH"
            echo "build/ipa ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la build/ipa/ || echo "build/ipa ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "âœ… IPA íŒŒì¼ í™•ì¸ë¨: $IPA_PATH"
          echo "íŒŒì¼ í¬ê¸°: $(du -h "$IPA_PATH" | cut -f1)"

      - name: Upload to TestFlight with Fastlane
        run: |
          echo "ğŸš€ Fastlaneì„ ì‚¬ìš©í•œ TestFlight ì—…ë¡œë“œ ì‹œì‘..."
          cd ios

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export CHANGELOG="${{ steps.read_changelog.outputs.changelog }}"
          export APP_STORE_CONNECT_API_KEY_PATH="${{ env.APP_STORE_CONNECT_API_KEY_PATH }}"
          export APPLE_ID="${{ secrets.APPLE_ID }}"

          echo "ğŸ“ ë³€ê²½ì‚¬í•­:"
          echo "$CHANGELOG"

          # Fastlane ì‹¤í–‰
          bundle exec fastlane upload_testflight

          echo "âœ… Fastlane TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"

      - name: TestFlight Upload Complete
        run: |
          echo "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
          echo "ì•±ì´ TestFlightì— ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."

  # ===============================================================
  # Job 4: Update README
  # ë°°í¬ ì™„ë£Œ í›„ main ë¸Œëœì¹˜ì˜ README íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
  # ===============================================================
  update-readme:
    name: ğŸ“ Update README
    needs: deploy-testflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get latest version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "latest_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update README.md
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d')
          VERSION_TEXT="v${{ steps.version.outputs.latest_version }} ($TIMESTAMP)"
          # READMEì—ì„œ ë²„ì „ ë¼ì¸ì„ ì°¾ì•„ ì—…ë°ì´íŠ¸ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
          sed -i -E "s/^(##\\s*(ìµœì‹ |Current|Recent|Latest)?\\s*ë²„ì „\\s*:\\s*).*/\\1${VERSION_TEXT}/i" README.md

      - name: Commit and push README update
        run: |
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: update README with version v${{ steps.version.outputs.latest_version }} [skip ci]"
            git push origin main
          else
            echo "No README changes to commit."
          fi

      - name: Merge PR to release branch
        run: |
          echo "ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. PRì„ ë³‘í•©í•©ë‹ˆë‹¤."
          gh pr merge ${{ github.event.pull_request.number }} --squash --admin
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
