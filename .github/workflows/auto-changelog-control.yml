# ===================================================================
# Wit í”„ë¡œì íŠ¸ ìë™ ì²´ì¸ì§€ë¡œê·¸ ê´€ë¦¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main -> release PRì´ ìƒì„±ë  ë•Œ CodeRabbit AIì˜ ë¦¬ë·°ë¥¼
# ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  íŒŒì‹±í•˜ì—¬ CHANGELOG.jsonê³¼ CHANGELOG.mdë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. main -> release PR ìƒì„± ì‹œ íŠ¸ë¦¬ê±°
# 2. iOS ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‹¤í–‰ (ë¹ ë¥¸ í”¼ë“œë°±)
# 3. CodeRabbit Summaryê°€ ìƒì„±ë  ë•Œê¹Œì§€ ìµœëŒ€ 10ë¶„ ëŒ€ê¸°
# 4. Summary ë‚´ìš©ì„ íŒŒì‹±í•˜ì—¬ CHANGELOG íŒŒì¼ë“¤ ì—…ë°ì´íŠ¸
# 5. ë²„ì „ ìë™ ì¦ê°€ ë° ë„¤ì´í‹°ë¸Œ íŒŒì¼ ë™ê¸°í™”
# 6. PR ìë™ ë¨¸ì§€ í›„ TestFlight ë°°í¬ íŠ¸ë¦¬ê±°
#
# ì§€ì› ê¸°ëŠ¥:
# - React Native í”„ë¡œì íŠ¸ ë²„ì „ ê´€ë¦¬ (package.json, Info.plist, build.gradle)
# - CodeRabbit Summaryì˜ ì‹¤ì‹œê°„ íŒŒì‹± ë° ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
# - JSON ë° Markdown í˜•ì‹ì˜ ì²´ì¸ì§€ë¡œê·¸ ìë™ ìƒì„±
# - README.md ë° PREVIOUS_CHANGES.md ìë™ ì—…ë°ì´íŠ¸
# - PR ìë™ ë¨¸ì§€ ë° TestFlight ë°°í¬ íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°
#
# ===================================================================

name: ğŸ¤– Auto CHANGELOG Control

on:
  pull_request_target:
    types: [opened, synchronize]
    branches: ['release']

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë° CodeRabbit Summary ê°ì§€
  build-and-detect:
    name: ğŸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë° ğŸ“‹ CodeRabbit Summary ê°ì§€
    runs-on: macos-14
    outputs:
      summary_found: ${{ steps.detect_summary.outputs.summary_found }}
      new_version: ${{ steps.versioning.outputs.new_version }}
      pr_number: ${{ steps.get_pr.outputs.pr_number }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get PR Number from pull_request_target
        id: get_pr
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR ë²ˆí˜¸: $PR_NUMBER"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          echo "ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
          if [ -f ".github/scripts/rn_version_manager.sh" ]; then
            chmod +x .github/scripts/rn_version_manager.sh
            echo "âœ… rn_version_manager.sh ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ rn_version_manager.sh íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'

      - name: Fix Xcode Project and Install CocoaPods
        run: |
          gem install cocoapods -N
          echo "ğŸ§¹ CocoaPods ìºì‹œ ì •ë¦¬ ì¤‘..."
          cd ios

          # ê¸°ì¡´ Pod ê´€ë ¨ íŒŒì¼ë“¤ ì •ë¦¬
          rm -rf Pods/
          rm -rf build/
          rm -f Podfile.lock

          # CocoaPods ìºì‹œ ì •ë¦¬
          pod cache clean --all

          echo "ğŸ”§ Xcode í”„ë¡œì íŠ¸ íŒŒì¼ ê²€ì¦ ë° ìˆ˜ì • ì¤‘..."

          # project.pbxproj íŒŒì¼ì—ì„œ ì˜ëª»ëœ shellScript ë°°ì—´ í˜•íƒœë¥¼ sedë¡œ ìˆ˜ì •
          PROJECT_FILE="Wit.xcodeproj/project.pbxproj"

          # ë°±ì—… ìƒì„±
          cp "$PROJECT_FILE" "${PROJECT_FILE}.backup"

          # shellScriptê°€ ë°°ì—´ í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆ˜ì •
          if grep -q 'shellScript = (' "$PROJECT_FILE"; then
            echo "âš ï¸ ì˜ëª»ëœ shellScript ë°°ì—´ í˜•íƒœ ë°œê²¬, sedë¡œ ìˆ˜ì • ì¤‘..."
            
            # sedë¥¼ ì‚¬ìš©í•œ ê°„ë‹¨í•œ ìˆ˜ì • (ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜)
            sed -i.tmp 's/shellScript = (/shellScript = "/g' "$PROJECT_FILE"
            sed -i.tmp 's/);$/";/g' "$PROJECT_FILE"
            sed -i.tmp 's/",$/\\n/g' "$PROJECT_FILE"
            sed -i.tmp 's/",$//g' "$PROJECT_FILE"
            
            rm "${PROJECT_FILE}.tmp"
            echo "âœ… project.pbxproj ìˆ˜ì • ì™„ë£Œ"
          else
            echo "âœ… project.pbxproj íŒŒì¼ì´ ì •ìƒì…ë‹ˆë‹¤"
          fi

          echo "ğŸ“¦ Pod ì¬ì„¤ì¹˜ ì¤‘..."
          pod install --repo-update --verbose

      - name: Build iOS (Simulator)
        env:
          RCT_NO_LAUNCH_PACKAGER: '1'
        run: |
          xcodebuild \
            -workspace ios/Wit.xcworkspace \
            -scheme Wit \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
            -derivedDataPath build \
            clean build

      - name: ğŸ‰ Build Test Success
        run: |
          echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„: CodeRabbit Summary ê°ì§€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."

      - name: Request CodeRabbit Summary
        run: |
          echo "ğŸ¤– CodeRabbitì—ê²Œ ë¦¬ë·° ìš”ì²­ ì¤‘..."
          gh pr comment ${{ steps.get_pr.outputs.pr_number }} --body "@coderabbitai review"
          echo "âœ… CodeRabbit ë¦¬ë·° ìš”ì²­ ì™„ë£Œ"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Wait for CodeRabbit Summary (Enhanced Detection)
        id: detect_summary
        continue-on-error: true
        timeout-minutes: 10
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"
          MAX_ATTEMPTS=120  # 10ë¶„ = 120 * 5ì´ˆ
          ATTEMPT=0

          echo "ğŸ” PR #$PR_NUMBERì—ì„œ CodeRabbit Summary ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œì‘..."
          echo "ìµœëŒ€ ëŒ€ê¸° ì‹œê°„: 10ë¶„ (5ì´ˆë§ˆë‹¤ ì²´í¬)"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "[$ATTEMPT/$MAX_ATTEMPTS] CodeRabbit Summary í™•ì¸ ì¤‘... ($(date '+%H:%M:%S'))"
            
            # GitHub APIë¡œ PR HTML ê°€ì ¸ì˜¤ê¸°
            curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.html" \
                 "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
                 > pr_content.html
            
            # "No description provided" ì²´í¬
            if grep -q "No description provided" pr_content.html; then
              echo "âŒ ì•„ì§ 'No description provided' ìƒíƒœì…ë‹ˆë‹¤"
            elif grep -q "Summary by CodeRabbit" pr_content.html; then
              echo "âœ… CodeRabbit Summary ë°œê²¬! íŒŒì‹±ì„ ì‹œì‘í•©ë‹ˆë‹¤"
              echo "summary_found=true" >> $GITHUB_OUTPUT
              break
            else
              echo "â³ CodeRabbit Summary ì•„ì§ ì—†ìŒ"
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            fi
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸ 10ë¶„ ëŒ€ê¸° í›„ì—ë„ CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "summary_found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Increment version and sync native files
        id: versioning
        run: |
          NEW_VERSION=$(./.github/scripts/rn_version_manager.sh increment)
          ./.github/scripts/rn_version_manager.sh sync
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ìƒˆ ë²„ì „: $NEW_VERSION"

      - name: Upload PR content for next job
        if: steps.detect_summary.outputs.summary_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-content-${{ steps.get_pr.outputs.pr_number }}
          path: pr_content.html
          retention-days: 1

  # Job 2: CHANGELOG ì—…ë°ì´íŠ¸ ë° ë¬¸ì„œ ìƒì„±
  update-changelog:
    name: ğŸ“ CHANGELOG ì—…ë°ì´íŠ¸ ë° ë¬¸ì„œ ìƒì„±
    runs-on: macos-14
    needs: build-and-detect
    if: needs.build-and-detect.outputs.summary_found == 'true'
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Download PR content
        uses: actions/download-artifact@v4
        with:
          name: pr-content-${{ needs.build-and-detect.outputs.pr_number }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Enhanced CodeRabbit Summary Parsing and CHANGELOG Update
        run: |
          PR_NUMBER="${{ needs.build-and-detect.outputs.pr_number }}"
          VERSION="${{ needs.build-and-detect.outputs.new_version }}"
          TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%SZ')

          echo "ğŸ“ CodeRabbit Summary ê°•í™”ëœ íŒŒì‹± ì‹œì‘..."
          echo "ğŸ“‹ ë²„ì „ ì •ë³´: v$VERSION (PR #$PR_NUMBER)"

          # Summary ì„¹ì…˜ ì¶”ì¶œ (ê°œì„ ëœ ë°©ì‹)
          echo "ğŸ” PR HTMLì—ì„œ CodeRabbit Summary ì¶”ì¶œ ì¤‘..."

          # 1. HTMLì—ì„œ Summary ì„¹ì…˜ ì¶”ì¶œ
          sed -n '/<h2[^>]*>Summary by CodeRabbit<\/h2>/,/<\/div>/p' pr_content.html > summary_section.html

          # 2. Summaryê°€ ì œëŒ€ë¡œ ì¶”ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
          SUMMARY_SIZE=$(wc -c < summary_section.html)
          echo "ğŸ“„ ì¶”ì¶œëœ Summary ì„¹ì…˜ í¬ê¸°: ${SUMMARY_SIZE} bytes"

          if [ "$SUMMARY_SIZE" -lt 100 ]; then
            echo "âš ï¸ Summary ì„¹ì…˜ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì¶”ì¶œ ì‹œë„..."
            # ë” ë„“ì€ ë²”ìœ„ë¡œ ì¶”ì¶œ
            sed -n '/Summary by CodeRabbit/,/<!-- end of auto-generated comment/p' pr_content.html > summary_section.html
            SUMMARY_SIZE=$(wc -c < summary_section.html)
            echo "ğŸ“„ ì¬ì¶”ì¶œëœ Summary ì„¹ì…˜ í¬ê¸°: ${SUMMARY_SIZE} bytes"
          fi

          # 3. HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
          cat summary_section.html | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g; s/&amp;/\&/g; s/&lt;/</g; s/&gt;/>/g; s/&quot;/"/g' > raw_summary.txt

          # 4. ì¶”ì¶œëœ ë‚´ìš© í™•ì¸ (ì „ì²´ ë‚´ìš© ì¶œë ¥)
          echo "ğŸ“‹ ì¶”ì¶œëœ Summary ì „ì²´ ë‚´ìš©:"
          echo "=========================================="
          cat raw_summary.txt
          echo "=========================================="

          echo "ğŸ“„ íŒŒì¼ í¬ê¸° ë° ì¤„ ìˆ˜:"
          echo "- íŒŒì¼ í¬ê¸°: $(wc -c < raw_summary.txt) bytes"
          echo "- ì¤„ ìˆ˜: $(wc -l < raw_summary.txt) lines"

          # Pythonìœ¼ë¡œ ì‹¤ì œ CodeRabbit Summary í˜•ì‹ì— ë§ëŠ” íŒŒì‹± ë¡œì§
          cat > parse_changelog.py << 'EOF'
          import re
          import json
          import html
          import sys
          import os
          from datetime import datetime

          def parse_coderabbit_summary(raw_text):
              """ì‹¤ì œ CodeRabbit Summary í˜•ì‹ì— ë§ëŠ” íŒŒì‹± ë¡œì§"""
              print("ğŸ” CodeRabbit Summary íŒŒì‹± ì‹œì‘...")
              print(f"ğŸ“„ ì›ë³¸ í…ìŠ¤íŠ¸ ê¸¸ì´: {len(raw_text)} characters")
              
              # í…ìŠ¤íŠ¸ ì •ë¦¬
              text = raw_text.strip()
              lines = [line.strip() for line in text.split('\n') if line.strip()]
              
              # ë””ë²„ê¹…ì„ ìœ„í•œ ì›ë³¸ í…ìŠ¤íŠ¸ ì „ì²´ ì¶œë ¥
              print("ğŸ“‹ ì›ë³¸ í…ìŠ¤íŠ¸ ì „ì²´ ë‚´ìš©:")
              print("=" * 80)
              for i, line in enumerate(lines):
                  print(f"{i+1:3d}: '{line}'")
              print("=" * 80)
              
              detected_categories = {}
              current_category = None
              current_items = []
              
              # ì‹¤ì œ CodeRabbit í˜•ì‹ì— ë§ëŠ” ì¹´í…Œê³ ë¦¬ ë§¤í•‘
              category_mapping = {
                  'New Features': 'new_features',
                  'Features': 'new_features',
                  'ì‹ ê·œ ê¸°ëŠ¥': 'new_features',
                  'ìƒˆë¡œìš´ ê¸°ëŠ¥': 'new_features',
                  
                  'Bug Fixes': 'bug_fixes',
                  'Fixes': 'bug_fixes',
                  'ë²„ê·¸ ìˆ˜ì •': 'bug_fixes',
                  'ìˆ˜ì •ì‚¬í•­': 'bug_fixes',
                  
                  'Style': 'style',
                  'UI/UX': 'style',
                  'ìŠ¤íƒ€ì¼': 'style',
                  
                  'Refactor': 'refactor',
                  'ë¦¬íŒ©í† ë§': 'refactor',
                  
                  'Chore': 'chores',
                  'Chores': 'chores',
                  'ì‘ì—…': 'chores',
                  'ê¸°íƒ€': 'chores',
                  
                  'Documentation': 'documentation',
                  'Docs': 'documentation',
                  'ë¬¸ì„œ': 'documentation',
                  'ë¬¸ì„œí™”': 'documentation',
                  
                  'Tests': 'tests',
                  'Testing': 'tests',
                  'í…ŒìŠ¤íŠ¸': 'tests',
                  
                  'Performance': 'performance',
                  'ì„±ëŠ¥': 'performance',
                  
                  'Security': 'security',
                  'ë³´ì•ˆ': 'security'
              }
              
              # ë¼ì¸ë³„ ì²˜ë¦¬
              for line_num, line in enumerate(lines):
                  print(f"ğŸ” [{line_num+1}] ì²˜ë¦¬ ì¤‘: '{line}'")
                  
                  # Summary by CodeRabbit í—¤ë” ìŠ¤í‚µ
                  if 'Summary by CodeRabbit' in line:
                      print(f"  â­ï¸ í—¤ë” ìŠ¤í‚µ")
                      continue
                  
                  # ì¹´í…Œê³ ë¦¬ ì œëª© ê°ì§€ (- ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°)
                  is_category = False
                  if line.startswith('- '):
                      # - New Features, - Documentation ë“±ì˜ í˜•ì‹
                      category_text = line[2:].strip()
                      if category_text in category_mapping:
                          # ì´ì „ ì¹´í…Œê³ ë¦¬ ì €ì¥
                          if current_category and current_items:
                              detected_categories[current_category] = current_items.copy()
                              print(f"âœ… ì¹´í…Œê³ ë¦¬ ì €ì¥: '{current_category}' -> {len(current_items)}ê°œ ì•„ì´í…œ")
                          
                          # ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œì‘
                          current_category = category_mapping[category_text]
                          current_items = []
                          is_category = True
                          print(f"ğŸ·ï¸ ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œì‘: '{category_text}' -> '{current_category}'")
                  
                  # ì¼ë°˜ ì¹´í…Œê³ ë¦¬ ì œëª© ê°ì§€ (- ì—†ì´)
                  elif line in category_mapping:
                      # ì´ì „ ì¹´í…Œê³ ë¦¬ ì €ì¥
                      if current_category and current_items:
                          detected_categories[current_category] = current_items.copy()
                          print(f"âœ… ì¹´í…Œê³ ë¦¬ ì €ì¥: '{current_category}' -> {len(current_items)}ê°œ ì•„ì´í…œ")
                      
                      # ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œì‘
                      current_category = category_mapping[line]
                      current_items = []
                      is_category = True
                      print(f"ğŸ·ï¸ ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œì‘: '{line}' -> '{current_category}'")
                  
                  if is_category:
                      continue
                  
                  # ì•„ì´í…œ ê°ì§€ (í˜„ì¬ ì¹´í…Œê³ ë¦¬ê°€ ìˆì„ ë•Œë§Œ)
                  if current_category:
                      # ë“¤ì—¬ì“°ê¸°ë‚˜ ë¶ˆë¦¿ í¬ì¸íŠ¸ê°€ ìˆëŠ” ì•„ì´í…œ
                      if line.startswith('  - '):
                          clean_item = line[4:].strip()
                          if clean_item and len(clean_item) > 10:
                              current_items.append(clean_item)
                              print(f"  ğŸ“ ë“¤ì—¬ì“°ê¸° ë¶ˆë¦¿ ì•„ì´í…œ: '{clean_item[:70]}...'")
                      elif line.startswith('- '):
                          clean_item = line[2:].strip()
                          if clean_item and len(clean_item) > 10:
                              current_items.append(clean_item)
                              print(f"  ğŸ“ ë¶ˆë¦¿ ì•„ì´í…œ: '{clean_item[:70]}...'")
                      # ì¼ë°˜ í…ìŠ¤íŠ¸ ì•„ì´í…œ (ë“¤ì—¬ì“°ê¸° ìˆìŒ)
                      elif line.startswith('  ') and len(line.strip()) > 15:
                          clean_item = line.strip()
                          current_items.append(clean_item)
                          print(f"  ğŸ“ ë“¤ì—¬ì“°ê¸° í…ìŠ¤íŠ¸ ì•„ì´í…œ: '{clean_item[:70]}...'")
                      # ì¹´í…Œê³ ë¦¬ ë°”ë¡œ ë‹¤ìŒ ì¤„ì˜ ë‚´ìš© (ë“¤ì—¬ì“°ê¸° ì—†ìŒ)
                      elif len(line) > 20 and not line.endswith(':') and not any(cat in line for cat in category_mapping.keys()):
                          current_items.append(line)
                          print(f"  ğŸ“ ì§ì ‘ í…ìŠ¤íŠ¸ ì•„ì´í…œ: '{line[:70]}...'")
              
              # ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ ì €ì¥
              if current_category and current_items:
                  detected_categories[current_category] = current_items.copy()
                  print(f"âœ… ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ ì €ì¥: '{current_category}' -> {len(current_items)}ê°œ ì•„ì´í…œ")
              
              print(f"ğŸ¯ ìµœì¢… ê°ì§€ëœ ì¹´í…Œê³ ë¦¬ ìˆ˜: {len(detected_categories)}")
              for category, items in detected_categories.items():
                  print(f"  ğŸ“‚ {category}: {len(items)}ê°œ ì•„ì´í…œ")
                  for i, item in enumerate(items):
                      print(f"    {i+1}. {item}")
              
              return detected_categories

          def main():
              # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
              version = os.environ.get('VERSION')
              pr_number = int(os.environ.get('PR_NUMBER'))
              timestamp = os.environ.get('TIMESTAMP')
              
              try:
                  # í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸°
                  with open('raw_summary.txt', 'r', encoding='utf-8') as f:
                      text_content = f.read()
                  
                  print(f"ğŸ“„ ì½ì–´ì˜¨ í…ìŠ¤íŠ¸ ë‚´ìš©:")
                  print("=" * 50)
                  print(text_content[:800] + "..." if len(text_content) > 800 else text_content)
                  print("=" * 50)
                  
                  # CodeRabbit Summary íŒŒì‹±
                  categories = parse_coderabbit_summary(text_content)
                  
                  # Raw summary ì €ì¥
                  raw_summary = text_content.strip() if text_content else "Summary parsing failed"
                  
                  # ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ ì—”íŠ¸ë¦¬ ìƒì„± (Wit í”„ë¡œì íŠ¸ í˜•ì‹)
                  new_release = {
                      "version": version,
                      "date": timestamp[0:10],
                      "timestamp": timestamp,
                      "pr_number": pr_number,
                      "project_type": "react-native",
                      "raw_summary": raw_summary,
                      "changes": categories  # ì§ì ‘ ì¹´í…Œê³ ë¦¬ í• ë‹¹
                  }
                  
                  print("ğŸ¯ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆ ì—”íŠ¸ë¦¬:")
                  for key, items in categories.items():
                      print(f"  - {key}: {len(items)}ê°œ í•­ëª©")
                      for item in items[:2]:
                          print(f"    â€¢ {item[:70]}...")
                  
                  # CHANGELOG.json ì—…ë°ì´íŠ¸
                  try:
                      with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                          changelog_data = json.load(f)
                  except (FileNotFoundError, json.JSONDecodeError):
                      changelog_data = {
                          "metadata": {
                              "lastUpdated": timestamp,
                              "currentVersion": version,
                              "projectType": "react-native",
                              "totalReleases": 0
                          },
                          "releases": []
                      }
                  
                  # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
                  if "metadata" not in changelog_data:
                      changelog_data["metadata"] = {}
                  
                  changelog_data["metadata"]["lastUpdated"] = timestamp
                  changelog_data["metadata"]["currentVersion"] = version
                  changelog_data["metadata"]["projectType"] = "react-native"
                  changelog_data["metadata"]["totalReleases"] = len(changelog_data.get("releases", [])) + 1
                  
                  # ìƒˆ ë¦´ë¦¬ì¦ˆë¥¼ ë§¨ ì•ì— ì¶”ê°€
                  if "releases" not in changelog_data:
                      changelog_data["releases"] = []
                  changelog_data["releases"].insert(0, new_release)
                  
                  # íŒŒì¼ ì €ì¥
                  with open('CHANGELOG.json', 'w', encoding='utf-8') as f:
                      json.dump(changelog_data, f, indent=2, ensure_ascii=False)
                  
                  print("âœ… CHANGELOG.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
                  total_items = sum(len(items) for items in categories.values())
                  print(f"ğŸ“Š ì´ {len(categories)}ê°œ ì¹´í…Œê³ ë¦¬, {total_items}ê°œ ë³€ê²½ì‚¬í•­")
                  
              except Exception as e:
                  print(f"âŒ íŒŒì‹± ì˜¤ë¥˜: {e}")
                  import traceback
                  print(f"ğŸ“‹ ìƒì„¸ ì˜¤ë¥˜:\n{traceback.format_exc()}")
                  
                  # ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì—”íŠ¸ë¦¬ ìƒì„±
                  fallback_release = {
                      "version": version,
                      "date": timestamp[0:10],
                      "timestamp": timestamp,
                      "pr_number": pr_number,
                      "project_type": "react-native",
                      "raw_summary": "íŒŒì‹± ì‹¤íŒ¨",
                      "changes": {
                          "general": [f"PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."]
                      }
                  }
                  
                  try:
                      with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                          changelog_data = json.load(f)
                  except:
                      changelog_data = {"releases": []}
                  
                  if "releases" not in changelog_data:
                      changelog_data["releases"] = []
                  changelog_data["releases"].insert(0, fallback_release)
                  
                  with open('CHANGELOG.json', 'w', encoding='utf-8') as f:
                      json.dump(changelog_data, f, indent=2, ensure_ascii=False)
                  
                  print("âš ï¸ ê¸°ë³¸ ì—”íŠ¸ë¦¬ë¡œ CHANGELOG.json ì—…ë°ì´íŠ¸ ì™„ë£Œ")

          if __name__ == "__main__":
              main()
          EOF

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •í•˜ê³  Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          export VERSION="$VERSION"
          export PR_NUMBER="$PR_NUMBER"
          export TIMESTAMP="$TIMESTAMP"

          python3 parse_changelog.py

      - name: Generate All Documentation Files
        run: |
          echo "ğŸ“„ ëª¨ë“  ë¬¸ì„œ íŒŒì¼ ìƒì„± ì¤‘..."

          python3 << 'PYTHON_SCRIPT'
          import json
          import os

          def get_category_title(key):
              """ì¹´í…Œê³ ë¦¬ í‚¤ë¥¼ í•œêµ­ì–´ ì œëª©ìœ¼ë¡œ ë³€í™˜"""
              category_titles = {
                  'new_features': 'ì‹ ê·œ ê¸°ëŠ¥',
                  'bug_fixes': 'ë²„ê·¸ ìˆ˜ì •', 
                  'style': 'ìŠ¤íƒ€ì¼',
                  'refactor': 'ë¦¬íŒ©í† ë§',
                  'chores': 'ì‘ì—… ì •ë¦¬',
                  'documentation': 'ë¬¸ì„œ',
                  'tests': 'í…ŒìŠ¤íŠ¸',
                  'performance': 'ì„±ëŠ¥',
                  'security': 'ë³´ì•ˆ',
                  'general': 'ì¼ë°˜'
              }
              return category_titles.get(key.lower(), key.replace('_', ' ').title())

          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              # 1. CHANGELOG.md ìƒì„±
              print("ğŸ“ CHANGELOG.md ìƒì„± ì¤‘...")
              with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
                  f.write("# CHANGELOG\n\n")
                  f.write("ì´ íŒŒì¼ì€ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.\n\n")

                  # ë©”íƒ€ë°ì´í„° ì •ë³´ ì¶”ê°€
                  metadata = data.get('metadata', {})
                  if metadata:
                      f.write(f"**í”„ë¡œì íŠ¸ íƒ€ì…:** {metadata.get('projectType', 'Unknown')}  \n")
                      f.write(f"**í˜„ì¬ ë²„ì „:** {metadata.get('currentVersion', 'Unknown')}  \n")
                      f.write(f"**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:** {metadata.get('lastUpdated', 'Unknown')}  \n\n")
                      f.write("---\n\n")

                  for release in data.get('releases', []):
                      version = release.get('version', 'Unknown')
                      date = release.get('date', release.get('timestamp', '')[:10])
                      pr_number = release.get('pr_number', 'N/A')
                      changes = release.get('changes', {})
                      
                      f.write(f"## v{version} ({date})\n\n")
                      f.write(f"**PR:** #{pr_number}\n\n")
                      
                      # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì¶œë ¥
                      if changes and any(items for items in changes.values() if items):
                          for category_key, items in changes.items():
                              if items and len(items) > 0:
                                  title = get_category_title(category_key)
                                  f.write(f"**{title}**\n")
                                  
                                  for item in items:
                                      f.write(f"- {item}\n")
                                  f.write("\n")
                      else:
                          # ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€
                          f.write(f"**ì¼ë°˜**\n")
                          f.write(f"- PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
                      
                      f.write("---\n\n")
              
              # 2. PREVIOUS_CHANGES.md ìƒì„±
              print("ğŸ“ PREVIOUS_CHANGES.md ìƒì„± ì¤‘...")
              with open('PREVIOUS_CHANGES.md', 'w', encoding='utf-8') as f:
                  f.write("# ì´ì „ ë³€ê²½ì‚¬í•­\n\n")
                  
                  # ìµœì‹  ë²„ì „(ì¸ë±ìŠ¤ 0)ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë²„ì „ë“¤ ì²˜ë¦¬
                  previous_releases = data.get('releases', [])[1:]
                  
                  if not previous_releases:
                      f.write("ì•„ì§ ì´ì „ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.\n")
                  else:
                      for release in previous_releases:
                          version = release.get('version', 'Unknown')
                          date = release.get('date', release.get('timestamp', '')[:10])
                          pr_number = release.get('pr_number', 'N/A')
                          changes = release.get('changes', {})
                          
                          f.write(f"## [{version}] - {date}\n\n")
                          f.write(f"**PR:** #{pr_number}\n\n")
                          
                          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì¶œë ¥
                          if changes and any(items for items in changes.values() if items):
                              for category_key, items in changes.items():
                                  if items and len(items) > 0:
                                      title = get_category_title(category_key)
                                      f.write(f"**{title}**\n")
                                      for item in items:
                                          f.write(f"- {item}\n")
                                      f.write("\n")
                          else:
                              # ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€
                              f.write(f"**ì¼ë°˜**\n")
                              f.write(f"- PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
                          
                          f.write("---\n\n")
              
              # 3. README.md ìƒì„±
              print("ğŸ“ README.md ìƒì„± ì¤‘...")
              if data.get('releases'):
                  latest_release = data['releases'][0]
                  version = latest_release.get('version', 'Unknown')
                  date = latest_release.get('date', latest_release.get('timestamp', '')[:10])
                  pr_number = latest_release.get('pr_number', 'N/A')
                  changes = latest_release.get('changes', {})
                  
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write("# Wit App\n\n")
                      f.write("ì—¬í–‰ ì¹œêµ¬ ì°¾ê¸°\n\n")
                      f.write("---\n\n")
                      f.write(f"## ìµœì‹  ë²„ì „: v{version} ({date})\n\n")
                      f.write(f"**PR:** #{pr_number}\n\n")
                      
                      # ë³€ê²½ì‚¬í•­ ì„¹ì…˜
                      f.write("### ë³€ê²½ ì‚¬í•­\n\n")
                      
                      if changes and any(items for items in changes.values() if items):
                          for category_key, items in changes.items():
                              if items and len(items) > 0:
                                  title = get_category_title(category_key)
                                  f.write(f"**{title}**\n")
                                  for item in items:
                                      f.write(f"- {item}\n")
                                  f.write("\n")
                      else:
                          f.write(f"**ì¼ë°˜**\n")
                          f.write(f"- PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
                      
                      # ì´ì „ ë³€ê²½ì‚¬í•­ ë§í¬
                      f.write("### ì´ì „ ë³€ê²½ ì‚¬í•­\n\n")
                      f.write("[ì´ì „ ë³€ê²½ì‚¬í•­ ë³´ê¸°](PREVIOUS_CHANGES.md)\n\n")
                      
                      # ë¬¸ì„œ ì„¹ì…˜
                      f.write("**DOCUMENTATION**\n\n")
                      f.write("- Expo -> Clië¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
                      f.write("---\n\n")
                      f.write("<!-- [ì´ì „ ë³€ê²½ì‚¬í•­ ë³´ê¸°](PREVIOUS_CHANGES.md) -->\n")
              
              print("âœ… ëª¨ë“  ë¬¸ì„œ íŒŒì¼ ìƒì„± ì™„ë£Œ!")
              
          except Exception as e:
              print(f"âŒ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨: {e}")
              import traceback
              print(f"ğŸ“‹ ìƒì„¸ ì˜¤ë¥˜:\n{traceback.format_exc()}")
              exit(1)
          PYTHON_SCRIPT

      - name: Commit and push all changes
        run: |
          echo "ğŸ“ ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤..."

          git add package.json ios/Wit/Info.plist android/app/build.gradle CHANGELOG.json CHANGELOG.md PREVIOUS_CHANGES.md README.md

          if ! git diff --staged --quiet; then
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            COMMIT_MSG="chore: update CHANGELOG to v${{ needs.build-and-detect.outputs.new_version }} [skip ci]"
            git commit -m "$COMMIT_MSG"
            
            echo "ğŸš€ main ë¸Œëœì¹˜ì— í‘¸ì‹œ ì¤‘..."
            git push origin main
            
            echo "ğŸ”„ PR ë¸Œëœì¹˜ë„ ë™ê¸°í™” ì¤‘..."
            # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_NUMBER="${{ needs.build-and-detect.outputs.pr_number }}"
            
            if [ -n "$PR_NUMBER" ]; then
              # PRì˜ í—¤ë“œ ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              PR_HEAD_REF=$(gh pr view $PR_NUMBER --json headRefName --jq '.headRefName')
              
              echo "ğŸ“‹ PR #$PR_NUMBERì˜ í—¤ë“œ ë¸Œëœì¹˜: $PR_HEAD_REF"
              
              # í—¤ë“œ ë¸Œëœì¹˜ê°€ mainì¸ ê²½ìš°ì—ë§Œ ë™ê¸°í™” (ë¬´í•œ ë£¨í”„ ë°©ì§€)
              if [ "$PR_HEAD_REF" = "main" ]; then
                echo "âœ… PR ë¸Œëœì¹˜ê°€ mainì´ë¯€ë¡œ ì´ë¯¸ ë™ê¸°í™”ë¨"
              else
                echo "ğŸ”„ PR ë¸Œëœì¹˜ $PR_HEAD_REFë¥¼ mainê³¼ ë™ê¸°í™” ì¤‘..."
                
                # PR ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ ë° ì—…ë°ì´íŠ¸
                git fetch origin
                git checkout -B "$PR_HEAD_REF" "origin/$PR_HEAD_REF"
                git merge main --no-edit
                git push origin "$PR_HEAD_REF"
                
                # main ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ê¸°
                git checkout main
                
                echo "âœ… PR ë¸Œëœì¹˜ ë™ê¸°í™” ì™„ë£Œ"
              fi
            else
              echo "âš ï¸ PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ PR ë¸Œëœì¹˜ ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
            fi
          else
            echo "ğŸ“„ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create and push Git tag
        run: |
          git tag "v${{ needs.build-and-detect.outputs.new_version }}"
          git push origin "v${{ needs.build-and-detect.outputs.new_version }}"

      - name: Cleanup
        run: |
          rm -f pr_content.html summary_section.html raw_summary.txt parse_changelog.py

  # Job 3: PR ë¨¸ì§€ ë° TestFlight ë°°í¬ íŠ¸ë¦¬ê±°
  merge-and-deploy:
    name: ğŸš€ PR ë¨¸ì§€ ë° TestFlight ë°°í¬ íŠ¸ë¦¬ê±°
    runs-on: macos-14
    needs: [build-and-detect, update-changelog]
    if: needs.build-and-detect.outputs.summary_found == 'true'
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Auto Merge PR
        run: |
          echo "ğŸ” PR ë²ˆí˜¸ ì¶”ì¶œ ë° ìë™ ë³‘í•© ì¤€ë¹„ ì¤‘..."

          PR_NUMBER="${{ needs.build-and-detect.outputs.pr_number }}"

          if [ -n "$PR_NUMBER" ]; then
            echo "ğŸ“‹ PR #$PR_NUMBER ì •ë³´ í™•ì¸ ì¤‘..."
            
            # PR ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_INFO=$(gh pr view $PR_NUMBER --json state,mergeable,baseRefName,headRefName)
            PR_STATE=$(echo "$PR_INFO" | jq -r '.state')
            PR_MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable')
            BASE_BRANCH=$(echo "$PR_INFO" | jq -r '.baseRefName')
            HEAD_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
            
            echo "ğŸ“Š PR ìƒíƒœ:"
            echo "  - ìƒíƒœ: $PR_STATE"
            echo "  - ë³‘í•© ê°€ëŠ¥: $PR_MERGEABLE"
            echo "  - ë² ì´ìŠ¤ ë¸Œëœì¹˜: $BASE_BRANCH"
            echo "  - í—¤ë“œ ë¸Œëœì¹˜: $HEAD_BRANCH"
            
            # main -> release PRì¸ì§€ í™•ì¸
            if [ "$BASE_BRANCH" = "release" ] && [ "$HEAD_BRANCH" = "main" ]; then
              echo "âœ… main -> release PR í™•ì¸ë¨"
              
              if [ "$PR_STATE" = "OPEN" ] && [ "$PR_MERGEABLE" = "MERGEABLE" ]; then
                echo "ğŸ‰ ëª¨ë“  CHANGELOG ì—…ë°ì´íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. PR #$PR_NUMBERì„ ìë™ ë³‘í•©í•©ë‹ˆë‹¤."
                
                # ë³‘í•© ì‹¤í–‰
                gh pr merge $PR_NUMBER --squash --admin --delete-branch
                
                echo "âœ… PR #$PR_NUMBER ë³‘í•© ì™„ë£Œ!"
                echo "ğŸ—‘ï¸ main ë¸Œëœì¹˜ ì‚­ì œ ì™„ë£Œ (--delete-branch)"
                echo "ğŸš€ TestFlight ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤."
              else
                echo "âš ï¸ PR ë³‘í•© ì¡°ê±´ ë¶ˆë§Œì¡±:"
                echo "  - ìƒíƒœê°€ OPENì´ ì•„ë‹ˆê±°ë‚˜ ë³‘í•© ë¶ˆê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤"
              fi
            else
              echo "â„¹ï¸ main -> release PRì´ ì•„ë‹™ë‹ˆë‹¤. ìë™ ë³‘í•©ì„ ê±´ë„ˆëœë‹ˆë‹¤."
              echo "  - í˜„ì¬: $HEAD_BRANCH -> $BASE_BRANCH"
            fi
          else
            echo "âš ï¸ PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìë™ ë³‘í•©ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Deployment Complete Notification
        run: |
          echo "ğŸ‰ CHANGELOG ì—…ë°ì´íŠ¸ ë° ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
          echo "  â€¢ ë²„ì „: v${{ needs.build-and-detect.outputs.new_version }}"
          echo "  â€¢ í”„ë¡œì íŠ¸ íƒ€ì…: React Native"
          echo "  â€¢ PR ë²ˆí˜¸: #${{ needs.build-and-detect.outputs.pr_number }}"
          echo "  â€¢ ë¸Œëœì¹˜: release"
          echo "  â€¢ ë‹¤ìŒ ë‹¨ê³„: TestFlight ìë™ ë°°í¬"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
