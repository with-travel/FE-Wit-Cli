# ===================================================================
# Wit í”„ë¡œì íŠ¸ ìë™ ì²´ì¸ì§€ë¡œê·¸ ê´€ë¦¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main -> release PRì´ ìƒì„±ë  ë•Œ CodeRabbit AIì˜ ë¦¬ë·°ë¥¼
# ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  íŒŒì‹±í•˜ì—¬ CHANGELOG.jsonê³¼ CHANGELOG.mdë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. main -> release PR ìƒì„± ì‹œ íŠ¸ë¦¬ê±°
# 2. iOS ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‹¤í–‰ (ë¹ ë¥¸ í”¼ë“œë°±)
# 3. ë²„ì „ ìë™ ì¦ê°€ ë° ë„¤ì´í‹°ë¸Œ íŒŒì¼ ë™ê¸°í™”
# 4. CodeRabbit Summaryê°€ ìƒì„±ë  ë•Œê¹Œì§€ ìµœëŒ€ 10ë¶„ ëŒ€ê¸°
# 5. Summary ë‚´ìš©ì„ íŒŒì‹±í•˜ì—¬ CHANGELOG íŒŒì¼ë“¤ ì—…ë°ì´íŠ¸
# 6. PREVIOUS_CHANGES.md ë° README.md ìë™ ì—…ë°ì´íŠ¸
# 7. PR ìë™ ë¨¸ì§€ í›„ TestFlight ë°°í¬ íŠ¸ë¦¬ê±°
#
# ì§€ì› ê¸°ëŠ¥:
# - React Native í”„ë¡œì íŠ¸ ë²„ì „ ê´€ë¦¬ (package.json, Info.plist, build.gradle)
# - CodeRabbit Summaryì˜ ì‹¤ì‹œê°„ íŒŒì‹± ë° ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
# - JSON ë° Markdown í˜•ì‹ì˜ ì²´ì¸ì§€ë¡œê·¸ ìë™ ìƒì„±
# - README.md ë° PREVIOUS_CHANGES.md ìë™ ì—…ë°ì´íŠ¸
# - PR ìë™ ë¨¸ì§€ í›„ TestFlight ë°°í¬ íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°
#
# ===================================================================

name: ğŸ“ CHANGELOG Update

on:
  workflow_run:
    workflows: ['ğŸ§ª Build Test']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: CodeRabbit Summary ê°ì§€
  detect-summary:
    name: ğŸ“‹ CodeRabbit Summary ê°ì§€
    runs-on: macos-14
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      summary_found: ${{ steps.detect_summary.outputs.summary_found }}
      pr_number: ${{ steps.get_pr.outputs.pr_number }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get PR Number from workflow_run
        id: get_pr
        run: |
          # workflow_runì—ì„œ PR ë²ˆí˜¸ ì¶”ì¶œ
          PR_NUMBER=$(gh api repos/${{ github.repository }}/pulls \
            --jq '.[] | select(.head.sha == "${{ github.event.workflow_run.head_sha }}") | .number' \
            | head -1)

          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR ë²ˆí˜¸: $PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          echo "ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
          if [ -f ".github/scripts/rn_version_manager.sh" ]; then
            chmod +x .github/scripts/rn_version_manager.sh
            echo "âœ… rn_version_manager.sh ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ rn_version_manager.sh íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: Request CodeRabbit Summary
        run: |
          echo "ğŸ¤– CodeRabbitì—ê²Œ ë¦¬ë·° ìš”ì²­ ì¤‘..."
          gh pr comment ${{ steps.get_pr.outputs.pr_number }} --body "@coderabbitai review"
          echo "âœ… CodeRabbit ë¦¬ë·° ìš”ì²­ ì™„ë£Œ"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Wait for CodeRabbit Summary (Enhanced Detection)
        id: detect_summary
        continue-on-error: true
        timeout-minutes: 10
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"
          MAX_ATTEMPTS=120  # 10ë¶„ = 120 * 5ì´ˆ
          ATTEMPT=0

          echo "ğŸ” PR #$PR_NUMBERì—ì„œ CodeRabbit Summary ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œì‘..."
          echo "ìµœëŒ€ ëŒ€ê¸° ì‹œê°„: 10ë¶„ (5ì´ˆë§ˆë‹¤ ì²´í¬)"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "[$ATTEMPT/$MAX_ATTEMPTS] CodeRabbit Summary í™•ì¸ ì¤‘... ($(date '+%H:%M:%S'))"
            
            # GitHub APIë¡œ PR HTML ê°€ì ¸ì˜¤ê¸°
            curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.html" \
                 "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
                 > pr_content.html
            
            # "No description provided" ì²´í¬
            if grep -q "No description provided" pr_content.html; then
              echo "âŒ ì•„ì§ 'No description provided' ìƒíƒœì…ë‹ˆë‹¤"
            elif grep -q "Summary by CodeRabbit" pr_content.html; then
              echo "âœ… CodeRabbit Summary ë°œê²¬! íŒŒì‹±ì„ ì‹œì‘í•©ë‹ˆë‹¤"
              echo "summary_found=true" >> $GITHUB_OUTPUT
              break
            else
              echo "â³ CodeRabbit Summary ì•„ì§ ì—†ìŒ"
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            fi
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸ 10ë¶„ ëŒ€ê¸° í›„ì—ë„ CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "summary_found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Upload PR content for next job
        if: steps.detect_summary.outputs.summary_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-content-${{ steps.get_pr.outputs.pr_number }}
          path: pr_content.html
          retention-days: 1

  # Job 2: ë²„ì „ ì—…ë°ì´íŠ¸ ë° CHANGELOG ìƒì„±
  update-changelog:
    name: ğŸ“ ë²„ì „ ì—…ë°ì´íŠ¸ ë° CHANGELOG ìƒì„±
    runs-on: macos-14
    needs: detect-summary
    if: needs.detect-summary.outputs.summary_found == 'true'
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Download PR content
        uses: actions/download-artifact@v4
        with:
          name: pr-content-${{ needs.detect-summary.outputs.pr_number }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          echo "ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
          if [ -f ".github/scripts/rn_version_manager.sh" ]; then
            chmod +x .github/scripts/rn_version_manager.sh
            echo "âœ… rn_version_manager.sh ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ rn_version_manager.sh íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: í˜„ì¬ ë²„ì „ í™•ì¸
        id: current_version
        run: |
          CURRENT_VERSION=$(./.github/scripts/rn_version_manager.sh get)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

      - name: ìƒˆ ë²„ì „ ê³„ì‚° (patch ë²„ì „ ì¦ê°€)
        id: version
        run: |
          VERSION="${{ steps.current_version.outputs.current_version }}"

          # patch ë²„ì „ ì¦ê°€ (1.0.54 â†’ 1.0.55)
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

      - name: package.json ë° ë„¤ì´í‹°ë¸Œ íŒŒì¼ ì—…ë°ì´íŠ¸
        run: |
          # rn_version_manager.shë¥¼ ì‚¬ìš©í•˜ì—¬ ë²„ì „ ì—…ë°ì´íŠ¸
          NEW_VERSION=$(./.github/scripts/rn_version_manager.sh increment)
          ./.github/scripts/rn_version_manager.sh sync
          echo "package.json ë° ë„¤ì´í‹°ë¸Œ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ: $NEW_VERSION"

      - name: ë™ì  Summary íŒŒì‹± ë° CHANGELOG.json ì—…ë°ì´íŠ¸
        run: |
          PR_NUMBER="${{ needs.detect-summary.outputs.pr_number }}"
          VERSION="${{ steps.version.outputs.new_version }}"
          TODAY=$(date '+%Y-%m-%d')
          TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%SZ')

          echo "ğŸ“ CodeRabbit Summary ë™ì  íŒŒì‹± ì‹œì‘..."

          # Summary ì„¹ì…˜ ì¶”ì¶œ (ë” ë„“ì€ ë²”ìœ„ë¡œ)
          sed -n '/<h2[^>]*>Summary by CodeRabbit<\/h2>/,/<\/div>/p' pr_content.html > summary_section.html

          # Summaryê°€ ì œëŒ€ë¡œ ì¶”ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
          echo "ğŸ“„ ì¶”ì¶œëœ Summary ì„¹ì…˜ í¬ê¸°: $(wc -c < summary_section.html) bytes"
          if [ $(wc -c < summary_section.html) -lt 100 ]; then
            echo "âš ï¸ Summary ì„¹ì…˜ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ì „ì²´ PR ë‚´ìš©ì—ì„œ ë‹¤ì‹œ ì¶”ì¶œ ì‹œë„..."
            grep -A 50 "Summary by CodeRabbit" pr_content.html > summary_section.html
          fi

          # Raw summary ì €ì¥ (ë°±ì—…ìš©)
          cat summary_section.html | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g; s/&amp;/\&/g; s/&lt;/</g; s/&gt;/>/g; s/&quot;/"/g' > raw_summary.txt

          echo "ğŸ” ë™ì  ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ ì¤‘..."
          echo "ğŸ“„ Summary ì„¹ì…˜ ë¯¸ë¦¬ë³´ê¸°:"
          head -10 summary_section.html

          # Pythonìœ¼ë¡œ ë™ì  íŒŒì‹± (changelog-update.yml ë°©ì‹)
          cat > parse_changelog.py << 'EOF'
          import re
          import json
          import html
          import sys
          import os
          from datetime import datetime

          def extract_items_from_section(html_content, section_title):
              """íŠ¹ì • ì„¹ì…˜ì˜ ì•„ì´í…œë“¤ì„ ì¶”ì¶œ"""
              print(f"ğŸ“‹ '{section_title}' ì„¹ì…˜ì—ì„œ ì•„ì´í…œ ì¶”ì¶œ ì¤‘...")
              
              # ë‹¤ì–‘í•œ íŒ¨í„´ìœ¼ë¡œ ì„¹ì…˜ ì°¾ê¸°
              patterns = [
                  f'<strong[^>]*>{re.escape(section_title)}[^<]*</strong>',  # ì§ì ‘ strong íƒœê·¸
                  f'<li[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong>',  # li > strong
                  f'<p[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong></p>'  # p > strong
              ]
              
              section_match = None
              for pattern in patterns:
                  section_match = re.search(pattern, html_content, re.IGNORECASE)
                  if section_match:
                      print(f"âœ… íŒ¨í„´ ë§¤ì¹˜: {pattern[:50]}...")
                      break
              
              if not section_match:
                  print(f"âŒ '{section_title}' ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                  return []
              
              # ì„¹ì…˜ ì´í›„ì˜ ul íƒœê·¸ ì°¾ê¸°
              after_section = html_content[section_match.end():]
              ul_match = re.search(r'<ul[^>]*>(.*?)</ul>', after_section, re.DOTALL)
              
              if not ul_match:
                  print(f"âŒ '{section_title}' ì„¹ì…˜ ì´í›„ ul íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                  return []
              
              # li íƒœê·¸ë“¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
              ul_content = ul_match.group(1)
              li_items = re.findall(r'<li[^>]*>(.*?)</li>', ul_content, re.DOTALL)
              
              items = []
              for item in li_items:
                  # HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                  clean_text = re.sub(r'<[^>]*>', '', item)
                  clean_text = html.unescape(clean_text).strip()
                  if clean_text:
                      items.append(clean_text)
                      print(f"  ğŸ“ ì•„ì´í…œ: {clean_text[:50]}...")
              
              print(f"âœ… '{section_title}' ì„¹ì…˜ì—ì„œ {len(items)}ê°œ ì•„ì´í…œ ì¶”ì¶œ ì™„ë£Œ")
              return items

          def detect_categories(html_content):
              """HTMLì—ì„œ ë™ì ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ê°ì§€ - AIê°€ ìƒì„±í•˜ëŠ” ëª¨ë“  ì¹´í…Œê³ ë¦¬ ìˆ˜ìš©"""
              print("ğŸ” HTMLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°ì§€ ì‹œì‘...")
              print(f"ğŸ“„ HTML ë‚´ìš© ê¸¸ì´: {len(html_content)} characters")
              
              detected_categories = {}
              
              # strong íƒœê·¸ ì•ˆì˜ ì¹´í…Œê³ ë¦¬ ì œëª©ë“¤ ì°¾ê¸°
              strong_texts = re.findall(r'<strong[^>]*>([^<]+)</strong>', html_content, re.IGNORECASE)
              print(f"ğŸ¯ ë°œê²¬ëœ strong íƒœê·¸ë“¤: {strong_texts}")
              
              for strong_text in strong_texts:
                  clean_text = strong_text.strip()
                  print(f"ğŸ·ï¸ ì²˜ë¦¬ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬: '{clean_text}'")
                  
                  # AIê°€ ìƒì„±í•œ ì¹´í…Œê³ ë¦¬ ì œëª©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                  items = extract_items_from_section(html_content, clean_text)
                  if items:
                      # ì¹´í…Œê³ ë¦¬ í‚¤ë¥¼ ì•ˆì „í•œ í˜•íƒœë¡œ ë³€í™˜ (ì†Œë¬¸ì, ê³µë°±ì„ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ)
                      safe_key = re.sub(r'[^a-zA-Z0-9ê°€-í£]', '_', clean_text.lower()).strip('_')
                      if not safe_key:  # ì•ˆì „í•œ í‚¤ê°€ ìƒì„±ë˜ì§€ ì•Šìœ¼ë©´ fallback
                          safe_key = f"category_{len(detected_categories)}"
                      
                      print(f"âœ… ì¹´í…Œê³ ë¦¬ ì¶”ê°€: '{clean_text}' -> '{safe_key}' ({len(items)}ê°œ ì•„ì´í…œ)")
                      detected_categories[safe_key] = {
                          'title': clean_text,
                          'items': items
                      }
                  else:
                      print(f"âŒ '{clean_text}' ì¹´í…Œê³ ë¦¬ì—ì„œ ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
              
              print(f"ğŸ¯ ìµœì¢… ê°ì§€ëœ ì¹´í…Œê³ ë¦¬ ìˆ˜: {len(detected_categories)}")
              return detected_categories

          def main():
              # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
              version = os.environ.get('VERSION')
              today = os.environ.get('TODAY')
              pr_number = int(os.environ.get('PR_NUMBER'))
              timestamp = os.environ.get('TIMESTAMP')
              
              try:
                  # HTML íŒŒì¼ ì½ê¸°
                  with open('summary_section.html', 'r', encoding='utf-8') as f:
                      html_content = f.read()
                  
                  print(f"ğŸ“„ ì½ì–´ì˜¨ HTML ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:")
                  print("=" * 50)
                  print(html_content[:500] + "..." if len(html_content) > 500 else html_content)
                  print("=" * 50)
                  
                  # ë™ì  ì¹´í…Œê³ ë¦¬ ê°ì§€
                  categories = detect_categories(html_content)
                  
                  print("ğŸ¯ ê°ì§€ëœ ì¹´í…Œê³ ë¦¬ë“¤:")
                  for key, value in categories.items():
                      print(f"  - {key}: {value['title']} ({len(value['items'])}ê°œ í•­ëª©)")
                      for item in value['items'][:3]:  # ì²« 3ê°œ ì•„ì´í…œë§Œ ë¯¸ë¦¬ë³´ê¸°
                          print(f"    â€¢ {item[:80]}...")
                  
                  # Raw summary ì½ê¸°
                  with open('raw_summary.txt', 'r', encoding='utf-8') as f:
                      raw_summary = f.read().strip()
                  
                  # ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ ì—”íŠ¸ë¦¬ ìƒì„± (changelog-update.yml ë°©ì‹)
                  new_release = {
                      "version": version,
                      "date": today,
                      "pr_number": pr_number,
                      "raw_summary": raw_summary,
                      "parsed_changes": {}
                  }
                  
                  # ë™ì  ì¹´í…Œê³ ë¦¬ë¥¼ parsed_changesì— ì¶”ê°€
                  if categories:
                      for key, value in categories.items():
                          new_release["parsed_changes"][key] = value["items"]
                          print(f"ğŸ“ parsed_changesì— ì¶”ê°€: {key} -> {len(value['items'])}ê°œ ì•„ì´í…œ")
                  else:
                      # ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í•­ëª© ì¶”ê°€
                      print("âš ï¸ ì¹´í…Œê³ ë¦¬ê°€ ê°ì§€ë˜ì§€ ì•Šì•„ ê¸°ë³¸ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤")
                      new_release["parsed_changes"]["general"] = [f"PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."]
                  
                  # CHANGELOG.json ì—…ë°ì´íŠ¸
                  try:
                      with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                          changelog_data = json.load(f)
                  except (FileNotFoundError, json.JSONDecodeError):
                      changelog_data = {
                          "metadata": {
                              "lastUpdated": timestamp,
                              "currentVersion": version,
                              "totalReleases": 0
                          },
                          "releases": []
                      }
                  
                  # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
                  changelog_data["metadata"]["lastUpdated"] = timestamp
                  changelog_data["metadata"]["currentVersion"] = version
                  changelog_data["metadata"]["totalReleases"] = len(changelog_data["releases"]) + 1
                  
                  # ìƒˆ ë¦´ë¦¬ì¦ˆë¥¼ ë§¨ ì•ì— ì¶”ê°€
                  changelog_data["releases"].insert(0, new_release)
                  
                  # íŒŒì¼ ì €ì¥
                  with open('CHANGELOG.json', 'w', encoding='utf-8') as f:
                      json.dump(changelog_data, f, indent=2, ensure_ascii=False)
                  
                  print("âœ… CHANGELOG.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
                  print(f"ğŸ“Š ì´ {len(categories)}ê°œ ì¹´í…Œê³ ë¦¬, {sum(len(v['items']) for v in categories.values())}ê°œ ë³€ê²½ì‚¬í•­")
                  
              except Exception as e:
                  print(f"âŒ íŒŒì‹± ì˜¤ë¥˜: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •í•˜ê³  Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          export VERSION="$VERSION"
          export TODAY="$TODAY"
          export PR_NUMBER="$PR_NUMBER"
          export TIMESTAMP="$TIMESTAMP"

          python3 parse_changelog.py

      - name: CHANGELOG.md ì¬ìƒì„±
        run: |
          echo "ğŸ“„ CHANGELOG.jsonì—ì„œ CHANGELOG.md ì¬ìƒì„± ì¤‘..."

          python3 << 'PYTHON_SCRIPT'
          import json

          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
                  f.write("# CHANGELOG\n\n")
                  f.write("ì´ íŒŒì¼ì€ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.\n\n")

                  for release in data['releases']:
                      version = release.get('version', 'Unknown')
                      date = release.get('date', release.get('timestamp', '')[:10])
                      pr_number = release.get('pr_number', 'N/A')
                      
                      f.write(f"## v{version} ({date})\n\n")
                      f.write(f"**PR:** #{pr_number}\n\n")
                      
                      # changes ë˜ëŠ” parsed_changes í•„ë“œ í™•ì¸ (í˜¸í™˜ì„±)
                      changes = release.get('parsed_changes', release.get('changes', {}))
                      
                      if changes and any(items for items in changes.values() if items):
                          # AIê°€ ìƒì„±í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì¶œë ¥
                          for category_key, items in changes.items():
                              if items:
                                  # JSONì—ì„œ ì›ë³¸ ì œëª© ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ í‚¤ë¥¼ ì œëª©ìœ¼ë¡œ ì‚¬ìš©)
                                  title = items.get('title', category_key.replace('_', ' ').title()) if isinstance(items, dict) else category_key.replace('_', ' ').title()
                                  
                                  # itemsê°€ dict í˜•íƒœì¸ì§€ í™•ì¸ (ìƒˆ í˜•ì‹)
                                  if isinstance(items, dict) and 'items' in items:
                                      actual_items = items['items']
                                      title = items['title']
                                  else:
                                      actual_items = items  # ê¸°ì¡´ í˜•ì‹ í˜¸í™˜
                                  
                                  f.write(f"**{title}**\n")
                                  
                                  for item in actual_items:
                                      f.write(f"- {item}\n")
                                  f.write("\n")
                      else:
                          # ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€
                          f.write(f"**ì¼ë°˜**\n")
                          f.write(f"- PR #{pr_number}ì˜ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
                      
                      f.write("---\n\n")
              
              print("âœ… CHANGELOG.md ì¬ìƒì„± ì™„ë£Œ!")
              
          except Exception as e:
              print(f"âŒ CHANGELOG.md ìƒì„± ì‹¤íŒ¨: {e}")
              import traceback
              print(f"ğŸ“‹ ìƒì„¸ ì˜¤ë¥˜:\n{traceback.format_exc()}")
              exit(1)
          PYTHON_SCRIPT

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add package.json ios/Wit/Info.plist android/app/build.gradle CHANGELOG.json CHANGELOG.md

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            git commit -m "chore: ë²„ì „ ${{ steps.version.outputs.new_version }} (PR #${{ needs.detect-summary.outputs.pr_number }}) [skip ci]"
            git push origin main
            echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: Create and push Git tag
        run: |
          VERSION="v${{ steps.version.outputs.new_version }}"

          echo "ğŸ·ï¸ Git íƒœê·¸ ìƒì„± ì¤‘: $VERSION"

          # ê¸°ì¡´ íƒœê·¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if git tag -l "$VERSION" | grep -q "$VERSION"; then
            echo "âš ï¸ íƒœê·¸ $VERSIONì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸°ì¡´ íƒœê·¸ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
            git tag -d "$VERSION" || true
            git push origin --delete "$VERSION" || true
          fi

          # ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git tag "$VERSION"
          git push origin "$VERSION"

          echo "âœ… Git íƒœê·¸ $VERSION ìƒì„± ë° í‘¸ì‹œ ì™„ë£Œ"

      - name: ì—…ë°ì´íŠ¸ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… CHANGELOG ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          echo "ğŸ“¦ ìƒˆ ë²„ì „: ${{ steps.version.outputs.new_version }}"
          echo "ğŸ”— PR: #${{ needs.detect-summary.outputs.pr_number }}"
          echo "ğŸ“„ package.json, CHANGELOG.json ë° CHANGELOG.mdê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ğŸ¯ ë™ì  ì¹´í…Œê³ ë¦¬ íŒŒì‹±ìœ¼ë¡œ AI ìƒì„± ì½˜í…ì¸  ìœ ì—°í•˜ê²Œ ì²˜ë¦¬ë¨"

      - name: ì •ë¦¬
        run: |
          rm -f pr_content.html summary_section.html raw_summary.txt parse_changelog.py
