name: ğŸ“ CHANGELOG Update

on:
  workflow_run:
    workflows: ['ğŸ§ª Build Test']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  changelog-update:
    name: ğŸ“ CHANGELOG Update
    runs-on: macos-14
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      new_version: ${{ steps.versioning.outputs.new_version }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get PR Number from workflow run
        id: get_pr
        run: |
          # workflow_runì—ì„œ PR ë²ˆí˜¸ ì¶”ì¶œ
          PR_NUMBER=$(gh api repos/${{ github.repository }}/pulls \
            --jq '.[] | select(.head.sha == "${{ github.event.workflow_run.head_sha }}") | .number' \
            | head -1)

          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ PR ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR ë²ˆí˜¸: $PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Request CodeRabbit Summary
        run: |
          gh pr comment ${{ steps.get_pr.outputs.pr_number }} --body "@coderabbitai review"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Wait for CodeRabbit Summary
        id: detect_summary
        continue-on-error: true
        timeout-minutes: 10
        run: |
          for i in {1..120}; do
            echo "[$i/120] Waiting for CodeRabbit summary..."
            PR_BODY=$(gh pr view ${{ steps.get_pr.outputs.pr_number }} --json body --jq .body)
            if [[ "$PR_BODY" == *"Summary by CodeRabbit"* ]]; then
              echo "âœ… Summary found!"
              echo "$PR_BODY" > summary_section.html
              echo "summary_found=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "âš ï¸ Timed out waiting for summary."
          echo "summary_found=false" >> $GITHUB_OUTPUT
          exit 1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission to scripts
        run: |
          chmod +x .github/scripts/rn_version_manager.sh
          chmod +x .github/scripts/changelog_manager.py

      - name: Increment version and sync native files
        id: versioning
        run: |
          NEW_VERSION=$(./.github/scripts/rn_version_manager.sh increment)
          ./.github/scripts/rn_version_manager.sh sync
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Dynamic Summary Parsing and CHANGELOG Update
        if: steps.detect_summary.outputs.summary_found == 'true'
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.pr_number }}"
          VERSION="${{ steps.versioning.outputs.new_version }}"
          TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%SZ')

          echo "ğŸ“ CodeRabbit Summary ë™ì  íŒŒì‹± ì‹œì‘..."

          # Pythonìœ¼ë¡œ ë™ì  íŒŒì‹±
          cat > parse_changelog.py << 'EOF'
          import re
          import json
          import html
          import sys
          import os
          from datetime import datetime

          def extract_items_from_section(html_content, section_title):
              """íŠ¹ì • ì„¹ì…˜ì˜ ì•„ì´í…œë“¤ì„ ì¶”ì¶œ"""
              print(f"ğŸ“‹ '{section_title}' ì„¹ì…˜ì—ì„œ ì•„ì´í…œ ì¶”ì¶œ ì¤‘...")
              
              # ë‹¤ì–‘í•œ íŒ¨í„´ìœ¼ë¡œ ì„¹ì…˜ ì°¾ê¸°
              patterns = [
                  f'<strong[^>]*>{re.escape(section_title)}[^<]*</strong>',
                  f'<li[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong>',
                  f'<p[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong></p>'
              ]
              
              section_match = None
              for pattern in patterns:
                  section_match = re.search(pattern, html_content, re.IGNORECASE)
                  if section_match:
                      print(f"âœ… íŒ¨í„´ ë§¤ì¹˜: {pattern[:50]}...")
                      break
              
              if not section_match:
                  print(f"âŒ '{section_title}' ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                  return []
              
              # ì„¹ì…˜ ì´í›„ì˜ ul íƒœê·¸ ì°¾ê¸°
              after_section = html_content[section_match.end():]
              ul_match = re.search(r'<ul[^>]*>(.*?)</ul>', after_section, re.DOTALL)
              
              if not ul_match:
                  print(f"âŒ '{section_title}' ì„¹ì…˜ ì´í›„ ul íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                  return []
              
              # li íƒœê·¸ë“¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
              ul_content = ul_match.group(1)
              li_items = re.findall(r'<li[^>]*>(.*?)</li>', ul_content, re.DOTALL)
              
              items = []
              for item in li_items:
                  # HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                  clean_text = re.sub(r'<[^>]*>', '', item)
                  clean_text = html.unescape(clean_text).strip()
                  if clean_text:
                      items.append(clean_text)
                      print(f"  ğŸ“ ì•„ì´í…œ: {clean_text[:50]}...")
              
              print(f"âœ… '{section_title}' ì„¹ì…˜ì—ì„œ {len(items)}ê°œ ì•„ì´í…œ ì¶”ì¶œ ì™„ë£Œ")
              return items

          def detect_categories(html_content):
              """HTMLì—ì„œ ë™ì ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ê°ì§€"""
              print("ğŸ” HTMLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°ì§€ ì‹œì‘...")
              print(f"ğŸ“„ HTML ë‚´ìš© ê¸¸ì´: {len(html_content)} characters")
              
              detected_categories = {}
              
              # ë‹¤ì–‘í•œ íŒ¨í„´ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ì™€ í•­ëª© ì°¾ê¸°
              patterns = [
                  # íŒ¨í„´ 1: â€¢ ì¹´í…Œê³ ë¦¬ëª… (ë¶ˆë¦¿ í¬ì¸íŠ¸)
                  r'â€¢\s*([^â€¢\n]+)',
                  # íŒ¨í„´ 2: strong íƒœê·¸
                  r'<strong[^>]*>([^<]+)</strong>',
                  # íŒ¨í„´ 3: li íƒœê·¸ ì•ˆì˜ strong
                  r'<li[^>]*>([^<\n]+)',
                  # íŒ¨í„´ 4: ì¼ë°˜ í…ìŠ¤íŠ¸ ë¼ì¸
                  r'^([A-Za-z\s]+)$'
              ]
              
              # HTMLì„ ì¤„ ë‹¨ìœ„ë¡œ ë¶„ì„
              lines = html_content.split('\n')
              current_category = None
              
              for line in lines:
                  line = line.strip()
                  if not line:
                      continue
                  
                  # HTML íƒœê·¸ ì œê±°
                  clean_line = re.sub(r'<[^>]*>', '', line).strip()
                  clean_line = html.unescape(clean_line)
                  
                  print(f"ğŸ” ì²˜ë¦¬ ì¤‘ì¸ ë¼ì¸: '{clean_line[:50]}...'")
                  
                  # ì¹´í…Œê³ ë¦¬ ê°ì§€ (New Features, Bug Fixes ë“±)
                  if any(keyword in clean_line for keyword in ['New Features', 'Bug Fixes', 'Style', 'Refactor', 'Chores']):
                      current_category = clean_line
                      safe_key = re.sub(r'[^a-zA-Z0-9ê°€-í£]', '_', current_category.lower()).strip('_')
                      if safe_key not in detected_categories:
                          detected_categories[safe_key] = []
                      print(f"âœ… ìƒˆ ì¹´í…Œê³ ë¦¬ ë°œê²¬: '{current_category}' -> '{safe_key}'")
                      continue
                  
                  # ì•„ì´í…œ ê°ì§€ (o ë˜ëŠ” â—‹ë¡œ ì‹œì‘í•˜ëŠ” í•­ëª©ë“¤)
                  if current_category and (clean_line.startswith('o ') or clean_line.startswith('â—‹ ') or len(clean_line) > 10):
                      item = clean_line.lstrip('o â—‹ ').strip()
                      if item and len(item) > 3:  # ì˜ë¯¸ìˆëŠ” ë‚´ìš©ë§Œ
                          safe_key = re.sub(r'[^a-zA-Z0-9ê°€-í£]', '_', current_category.lower()).strip('_')
                          if safe_key not in detected_categories:
                              detected_categories[safe_key] = []
                          detected_categories[safe_key].append(item)
                          print(f"  ğŸ“ ì•„ì´í…œ ì¶”ê°€: '{item[:30]}...'")
              
              # ë¹ˆ ì¹´í…Œê³ ë¦¬ ì œê±°
              detected_categories = {k: v for k, v in detected_categories.items() if v}
              
              print(f"ğŸ¯ ìµœì¢… ê°ì§€ëœ ì¹´í…Œê³ ë¦¬ ìˆ˜: {len(detected_categories)}")
              for category, items in detected_categories.items():
                  print(f"  ğŸ“‚ {category}: {len(items)}ê°œ ì•„ì´í…œ")
              
              return detected_categories

          def main():
              # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
              version = os.environ.get('VERSION')
              pr_number = int(os.environ.get('PR_NUMBER'))
              timestamp = os.environ.get('TIMESTAMP')
              
              try:
                  # HTML íŒŒì¼ ì½ê¸°
                  with open('summary_section.html', 'r', encoding='utf-8') as f:
                      html_content = f.read()
                  
                  print(f"ğŸ“„ ì½ì–´ì˜¨ HTML ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:")
                  print("=" * 50)
                  print(html_content[:500] + "..." if len(html_content) > 500 else html_content)
                  print("=" * 50)
                  
                  # ë™ì  ì¹´í…Œê³ ë¦¬ ê°ì§€
                  categories = detect_categories(html_content)
                  
                  # ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ ì—”íŠ¸ë¦¬ ìƒì„±
                  new_release = {
                      "version": version,
                      "timestamp": timestamp,
                      "pr_number": str(pr_number),
                      "changes": categories
                  }
                  
                  # CHANGELOG.json ì—…ë°ì´íŠ¸
                  try:
                      with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                          changelog_data = json.load(f)
                  except (FileNotFoundError, json.JSONDecodeError):
                      changelog_data = {"releases": []}
                  
                  # ìƒˆ ë¦´ë¦¬ì¦ˆë¥¼ ë§¨ ì•ì— ì¶”ê°€
                  changelog_data["releases"].insert(0, new_release)
                  
                  # íŒŒì¼ ì €ì¥
                  with open('CHANGELOG.json', 'w', encoding='utf-8') as f:
                      json.dump(changelog_data, f, indent=2, ensure_ascii=False)
                  
                  print("âœ… CHANGELOG.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
                  print(f"ğŸ“Š ì´ {len(categories)}ê°œ ì¹´í…Œê³ ë¦¬, {sum(len(items) for items in categories.values())}ê°œ ë³€ê²½ì‚¬í•­")
                  
              except Exception as e:
                  print(f"âŒ íŒŒì‹± ì˜¤ë¥˜: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •í•˜ê³  Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          export VERSION="$VERSION"
          export PR_NUMBER="$PR_NUMBER"
          export TIMESTAMP="$TIMESTAMP"

          python3 parse_changelog.py

      - name: Generate CHANGELOG.md from JSON
        if: steps.detect_summary.outputs.summary_found == 'true'
        run: |
          echo "ğŸ“„ CHANGELOG.jsonì—ì„œ CHANGELOG.md ì¬ìƒì„± ì¤‘..."

          python3 << 'PYTHON_SCRIPT'
          import json

          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
                  f.write("# CHANGELOG\n\n")
                  f.write("ì´ íŒŒì¼ì€ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.\n")

                  for release in data['releases']:
                      f.write(f"## v{release['version']} ({release['timestamp'][0:10]})\n")
                      
                      # ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì •ë¦¬ëœ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ (Expo ë°©ì‹)
                      for category_key, items in release['changes'].items():
                          if items:
                              # ì¹´í…Œê³ ë¦¬ëª…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜ (ì˜ì–´ ì›ë¬¸ ê¸°ì¤€)
                              category_titles = {
                                  'new_features': 'ìƒˆë¡œìš´ ê¸°ëŠ¥',
                                  'bug_fixes': 'ë²„ê·¸ ìˆ˜ì •', 
                                  'style': 'ìŠ¤íƒ€ì¼ ê°œì„ ',
                                  'refactor': 'ë¦¬íŒ©í† ë§',
                                  'chores': 'ì‘ì—… ì •ë¦¬',
                                  'features': 'ìƒˆë¡œìš´ ê¸°ëŠ¥',
                                  'documentation': 'ë¬¸ì„œí™”',
                                  'test': 'í…ŒìŠ¤íŠ¸',
                                  'general': 'ì¼ë°˜',
                                  # ì¶”ê°€ ë§¤í•‘
                                  'ui': 'UI ê°œì„ ',
                                  'performance': 'ì„±ëŠ¥ ê°œì„ ',
                                  'security': 'ë³´ì•ˆ',
                                  'api': 'API'
                              }
                              
                              title = category_titles.get(category_key.lower(), category_key.replace('_', ' ').title())
                              f.write(f"\n**{title}**\n")
                              
                              for item in items:
                                  f.write(f"- {item}\n")
                      
                      f.write("\n---\n\n")
              
              print("âœ… CHANGELOG.md ì¬ìƒì„± ì™„ë£Œ!")
              
          except Exception as e:
              print(f"âŒ CHANGELOG.md ìƒì„± ì‹¤íŒ¨: {e}")
              exit(1)
          PYTHON_SCRIPT

      - name: Generate PREVIOUS_CHANGES.md from JSON
        if: steps.detect_summary.outputs.summary_found == 'true'
        run: |
          echo "ğŸ“„ PREVIOUS_CHANGES.md ìƒì„± ì¤‘..."

          if [ -f "CHANGELOG.json" ]; then
            # CHANGELOG.jsonì—ì„œ ìµœì‹  ë²„ì „ì„ ì œì™¸í•œ ì´ì „ ë²„ì „ë“¤ë¡œ PREVIOUS_CHANGES.md ìƒì„± (Expo ë°©ì‹)
            jq -r '
              "# ì´ì „ ë³€ê²½ì‚¬í•­\n\n" +
              (.releases[1:] | map(
                "## [" + .version + "] - " + .timestamp[0:10] + "\n" +
                (.changes | to_entries | map(
                  "\n**" + (
                    if .key == "new_features" then "ìƒˆë¡œìš´ ê¸°ëŠ¥"
                    elif .key == "bug_fixes" then "ë²„ê·¸ ìˆ˜ì •"
                    elif .key == "style" then "ìŠ¤íƒ€ì¼ ê°œì„ "
                    elif .key == "refactor" then "ë¦¬íŒ©í† ë§"
                    elif .key == "chores" then "ì‘ì—… ì •ë¦¬"
                    elif .key == "features" then "ìƒˆë¡œìš´ ê¸°ëŠ¥"
                    elif .key == "documentation" then "ë¬¸ì„œí™”"
                    elif .key == "test" then "í…ŒìŠ¤íŠ¸"
                    elif .key == "ui" then "UI ê°œì„ "
                    elif .key == "performance" then "ì„±ëŠ¥ ê°œì„ "
                    elif .key == "security" then "ë³´ì•ˆ"
                    elif .key == "api" then "API"
                    else (.key | gsub("_"; " ") | ascii_upcase)
                    end
                  ) + "**\n" + 
                  (.value | map("- " + .) | join("\n"))
                ) | join("\n")) + "\n\n---\n"
              ) | join("\n"))
            ' CHANGELOG.json > PREVIOUS_CHANGES.md
            
            echo "âœ… PREVIOUS_CHANGES.md ìƒì„± ì™„ë£Œ"
          else
            echo "# ì´ì „ ë³€ê²½ì‚¬í•­" > PREVIOUS_CHANGES.md
            echo "" >> PREVIOUS_CHANGES.md
            echo "ì•„ì§ ì´ì „ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤." >> PREVIOUS_CHANGES.md
            echo "âš ï¸ CHANGELOG.jsonì´ ì—†ì–´ ê¸°ë³¸ PREVIOUS_CHANGES.md ìƒì„±"
          fi

      - name: Commit and push CHANGELOG updates
        run: |
          git add package.json ios/Wit/Info.plist android/app/build.gradle CHANGELOG.json CHANGELOG.md PREVIOUS_CHANGES.md
          if ! git diff --staged --quiet; then
            git commit -m "chore: update CHANGELOG to v${{ steps.versioning.outputs.new_version }} [skip ci]"
            git push origin main
          else
            echo "No CHANGELOG changes to commit."
          fi

      - name: Create and push Git tag
        run: |
          git tag "v${{ steps.versioning.outputs.new_version }}"
          git push origin "v${{ steps.versioning.outputs.new_version }}"

      - name: Verify CHANGELOG generation
        run: |
          echo "ğŸ“‹ ìƒì„±ëœ CHANGELOG.md í™•ì¸:"
          if [ -f "CHANGELOG.md" ]; then
            echo "âœ… CHANGELOG.md íŒŒì¼ ì¡´ì¬"
            echo "ğŸ“„ ìµœì‹  ë²„ì „ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
            head -20 CHANGELOG.md
          else
            echo "âŒ CHANGELOG.md íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: ğŸ‰ CHANGELOG Update Success
        run: |
          echo "âœ… CHANGELOG ì—…ë°ì´íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“¦ ìƒˆ ë²„ì „: v${{ steps.versioning.outputs.new_version }}"
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„: TestFlight ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤."
