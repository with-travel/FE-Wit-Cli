default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # 인증서 및 프로파일 설정
    setup_ci if ENV['CI']
    
    # 코드 사이닝 (자동으로 인증서/프로파일 매칭)
    match(
      type: "appstore",
      readonly: true,
      keychain_name: ENV['MATCH_KEYCHAIN_NAME'] || 'fastlane_tmp_keychain',
      keychain_password: ENV['MATCH_KEYCHAIN_PASSWORD'] || ''
    )
    
    # 버전 업데이트
    increment_build_number(
      build_number: ENV['BUILD_NUMBER'] || latest_testflight_build_number + 1
    )
    
    # 빌드
    build_app(
      workspace: "Wit.xcworkspace",
      scheme: "Wit",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        method: "app-store-connect",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        stripSwiftSymbols: true
      }
    )
    
    # TestFlight 업로드
    upload_to_testflight(
      api_key_path: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
      skip_waiting_for_build_processing: true,
      changelog: ENV['CHANGELOG'] || "새로운 빌드가 업로드되었습니다."
    )
  end
end
